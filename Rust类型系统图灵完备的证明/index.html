<!DOCTYPE html>
<html lang="zh-CN">
  <head>
  <meta charset="UTF-8">
  <meta 
    name="viewport"
    content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <meta 
    http-equiv="X-UA-Compatible" 
    content="ie=edge">
  <meta 
    name="theme-color" 
    content="#fff" 
    id="theme-color">
  <meta 
    name="description" 
    content="网络安全 Android ML CTF">
  <link 
    rel="icon" 
    href="/images/logo.png">
  <title>Rust类型系统图灵完备的证明</title>
  
    
      <meta 
        property="og:title" 
        content="Rust类型系统图灵完备的证明">
    
    
      <meta 
        property="og:url" 
        content="https://ch3nye.top/Rust%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%E5%9B%BE%E7%81%B5%E5%AE%8C%E5%A4%87%E7%9A%84%E8%AF%81%E6%98%8E/index.html">
    
    
      <meta 
        property="og:img" 
        content="/images/logo.png">
    
    
      <meta 
        property="og:img" 
        content="网络安全 Android ML CTF">
    
    
      <meta 
        property="og:type" 
        content="article">
      <meta 
        property="og:article:published_time" 
        content="2022-05-04">
      <meta 
        property="og:article:modified_time" 
        content="2022-05-04">
      <meta 
        property="og:article:author" 
        content="Ch3nYe">
      
        
          <meta 
            property="og:article:tag" 
            content="翻译">
        
          <meta 
            property="og:article:tag" 
            content="Rust - Smallfuck - turing-complete">
        
      
    
  
  <script>
    function loadScript(url, cb) {
      var script = document.createElement('script');
      script.src = url;
      if (cb) script.onload = cb;
      script.async = true;
      document.body.appendChild(script);
    }
    function loadCSS(href, data, attr) {
      var sheet = document.createElement('link');
      sheet.ref = 'stylesheet';
      sheet.href = href;
      sheet.dataset[data] = attr;
      document.head.appendChild(sheet);
    }
    function changeCSS(cssFile, data, attr) {
      var oldlink = document.querySelector(data);
      var newlink = document.createElement("link");
      newlink.setAttribute("rel", "stylesheet");
      newlink.setAttribute("href", cssFile);
      newlink.dataset.prism = attr;
      document.head.replaceChild(newlink, oldlink);
    }
  </script>
  
    
      
      
      
      
        
        
        
        <script>
          function prismThemeChange() {
            if(document.getElementById('theme-color').dataset.mode === 'dark') {
              if(document.querySelector('[data-prism]')) {
                changeCSS('/js/lib/prism/prism-tomorrow.min.css', '[data-prism]', 'prism-tomorrow');
              } else {
                loadCSS('/js/lib/prism/prism-tomorrow.min.css', 'prism', 'prism-tomorrow');
              }
            } else {
              if(document.querySelector('[data-prism]')) {
                changeCSS('/js/lib/prism/prism.min.css', '[data-prism]', 'prism');
              } else {
                loadCSS('/js/lib/prism/prism.min.css', 'prism', 'prism');
              }
            }
          }
          prismThemeChange()
        </script>
      
      
        
        <link rel="stylesheet" href="/js/lib/prism/prism-line-numbers.min.css">
      
    
  
  <script>
    // control reverse button
    var reverseDarkList = {
      dark: 'light',
      light: 'dark'
    };
    var themeColor = {
      dark: '#1c1c1e',
      light: '#fff'
    }
    // get the data of css prefers-color-scheme
    var getCssMediaQuery = function() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };
    // reverse current darkmode setting function
    var reverseDarkModeSetting = function() {
      var setting = localStorage.getItem('user-color-scheme');
      if(reverseDarkList[setting]) {
        setting = reverseDarkList[setting];
      } else if(setting === null) {
        setting = reverseDarkList[getCssMediaQuery()];
      } else {
        return;
      }
      localStorage.setItem('user-color-scheme', setting);
      return setting;
    };
    // apply current darkmode setting
  </script>
  
    <script>
      var setDarkmode = function(mode) {
      var setting = mode || localStorage.getItem('user-color-scheme');
      if(setting === getCssMediaQuery()) {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[setting];
        document.getElementById('theme-color').dataset.mode = setting;
        prismThemeChange();
      } else if(reverseDarkList[setting]) {
        document.documentElement.setAttribute('data-user-color-scheme', setting);
        document.getElementById('theme-color').content = themeColor[setting];
        document.getElementById('theme-color').dataset.mode = setting;
        prismThemeChange();
      } else {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[getCssMediaQuery()];
        document.getElementById('theme-color').dataset.mode = getCssMediaQuery();
        prismThemeChange();
      }
    };
    setDarkmode();
    </script>
  
  
  <link rel="preload" href="//at.alicdn.com/t/font_1946621_i1kgafibvw.css" as="style" >
  <link rel="preload" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css" as="style" >
  
  
    <link rel="preload" href="/js/lib/lightbox/baguetteBox.min.js" as="script">
    <link rel="preload" href="/js/lib/lightbox/baguetteBox.min.css" as="style" >
  
  
    <link rel="preload" href="/js/lib/lozad.min.js" as="script">
  
  
  
  
    
    <link rel="prefetch" href="//cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" as="script">
  
  
    
    <link rel="prefetch" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" as="script">
  
  
  
  <link rel="stylesheet" href="/css/main.css">
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1946621_i1kgafibvw.css">
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css">
  
    <link rel="stylesheet" href="/js/lib/lightbox/baguetteBox.min.css">
  
<meta name="generator" content="Hexo 5.3.0"></head>

  <body>
    <div class="wrapper">
       
      <nav class="navbar">
  <div class="navbar-logo">
    <span class="navbar-logo-main">
      
        <img 
          class="navbar-logo-img"
          width="32"
          height="32"
          src="/images/logo.png" 
          alt="blog logo">
      
      <span class="navbar-logo-dsc">ch3nye's blog</span>
    </span>
  </div>
  <div class="navbar-menu">
    
      <a 
        href="/" 
        class="navbar-menu-item">
        
          首页
        
      </a>
    
      <a 
        href="/archives" 
        class="navbar-menu-item">
        
          归档
        
      </a>
    
      <a 
        href="/tags" 
        class="navbar-menu-item">
        
          标签
        
      </a>
    
      <a 
        href="/categories" 
        class="navbar-menu-item">
        
          分类
        
      </a>
    
      <a 
        href="/about" 
        class="navbar-menu-item">
        
          关于
        
      </a>
    
      <a 
        href="/links" 
        class="navbar-menu-item">
        
          友链
        
      </a>
    
      <a 
        href="/shuoshuo" 
        class="navbar-menu-item">
        
          说说
        
      </a>
    
    <a 
      class="navbar-menu-item darknavbar" 
      id="dark">
      <i class="iconfont icon-weather"></i>
    </a>
    <a 
      class="navbar-menu-item searchnavbar" 
      id="search">
      <i 
        class="iconfont icon-search" 
        style="font-size: 1.2rem; font-weight: 400;">
      </i>
    </a>
  </div>
</nav> 
      
      <div 
        id="local-search" 
        style="display: none">
        <input
          class="navbar-menu-item"
          id="search-input"
          placeholder="请输入搜索内容..." />
        <div id="search-content"></div>
      </div>
      
      <div class="section-wrap">
        <div class="container">
          <div class="columns">
            <main class="main-column">
<article class="card card-content">
  <header>
    <h1 class="post-title">
      Rust类型系统图灵完备的证明
    </h1>
  </header>
  <div class="post-meta post-show-meta">
    <time datetime="2022-05-03T16:00:00.000Z">
      <i 
        class="iconfont icon-calendar" 
        style="margin-right: 2px;">
      </i>
      <span>2022-05-04</span>
    </time>
    
      <span class="dot"></span>
      
        <a 
          href="/categories/%E7%BF%BB%E8%AF%91/" 
          class="post-meta-link">
          翻译
        </a>
      
    
    
      <span class="dot"></span>
      <span>8.7k 字</span>
    
  </div>
  
    <div 
      class="post-meta post-show-meta" 
      style="margin-top: -10px;">
      <div style="display: flex; align-items: center;">
        <i 
          class="iconfont icon-biaoqian" 
          style="margin-right: 2px; font-size: 1.15rem;">
        </i>
        
          
          <a 
            href="/tags/%E7%BF%BB%E8%AF%91/" 
            class="post-meta-link">
            翻译
          </a>
        
          
            <span class="dot"></span>
          
          <a 
            href="/tags/Rust-Smallfuck-turing-complete/" 
            class="post-meta-link">
            Rust - Smallfuck - turing-complete
          </a>
        
      </div>
    </div>
  
  </header>
  <div 
    id="section" 
    class="post-content">
    <blockquote>
<p>原文链接: <a target="_blank" rel="noopener" href="https://sdleffler.github.io/RustTypeSystemTuringComplete/">https://sdleffler.github.io/RustTypeSystemTuringComplete/</a></p>
<p><strong>翻译：<a target="_blank" rel="noopener" href="https://github.com/Ch3nYe">ChenYe</a></strong><br />
选题：aresbit</p>
<p>本文由 <a target="_blank" rel="noopener" href="https://Rustt.org">Rustt</a> 翻译，<a target="_blank" rel="noopener" href="https://studyrust.org">StudyRust</a> 荣誉推出</p>
</blockquote>
<h1 id="rust类型系统图灵完备的证明"><a class="markdownIt-Anchor" href="#rust类型系统图灵完备的证明"></a> Rust类型系统图灵完备的证明</h1>
<blockquote>
<p>TL;DR: 本文使用 Rust 类型系统实现了 Smallfuck 的所用功能，证明了 Rust 的类型系统是图灵完备的。</p>
<p>译者前言：阅读本文需要了解 Rust 的 trait 机制，associated types ，以及泛型的相关知识。阅读时长约2h。</p>
</blockquote>
<p><em>（注意：“fuck” 在本文中出现多次，但这个词在这里并不是污言秽语。）</em></p>
<p>不久前，有人在 <a target="_blank" rel="noopener" href="https://www.reddit.com/r/rust/comments/5y4x9r/challenge_rusts_type_system_is_not_turing_complete/">Reddit Rust 子论坛</a>上提出挑战：虽然每个人都喜欢说 Rust 的类型系统是图灵完备的，但实际上似乎还没有人给出确凿的证据。作为对那篇文章的回应，我以使用<a target="_blank" rel="noopener" href="https://github.com/sdleffler/tarpit-rs">Rust 实现 Smallfuck</a>（一种已知的图灵完备语言）的方式给出了一个证明，说明 Rust 的类型系统是图灵完备的。这篇文章将阐述 Smallfuck 的 Rust 实现的内部工作原理，以及这对 Rust 类型系统的意义。</p>
<p>那么什么是图灵完备性呢？图灵完备性是大多数编程语言的一个属性，它表明这些语言可以模拟通用图灵机。与之相关的概念是图灵等效。图灵等效语言可以模拟图灵机也可以被图灵机模拟——因此，如果你有任何两种图灵等效语言，则一定可以将使用一种语言编写的任何程序翻译成另一种语言所编写的程序。大多数图灵完备的系统也被认为是图灵等效的。（<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Turing_completeness#Formal_definitions">wiki</a>）</p>
<p>关于图灵完备性，有几件重要的事情需要注意。假定你知道<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Halting_problem">停机问题</a>， 如果一个系统是图灵完备的，那么也意味着停机问题不可解决。也就是说，如果你有一种图灵完备的语言，它可以模拟任何通用图灵机，那么它必须能够无限循环。这就是为什么知道 Rust 的类型系统是否是图灵完备的很有用——这意味着，如果你能够将图灵完备的语言编码到 Rust 的类型系统中，那么检查 Rust 程序以确保它的类型是否正确的过程必须是<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Undecidable_problem">不可判定的问题</a>。即类型检查器必须能够进行无限循环。</p>
<p>我们如何证明 Rust 类型系统是图灵完备的？最直接的方法（实际上我不知道其他方法）是在其中实现一种已知的图灵完备语言。如果你可以用一种语言实现图灵完备的语言，那么你可以清楚地在其中模拟任何通用图灵机，也就说明这种语言是图灵完备的。</p>
<h2 id="smallfuck-有啥用"><a class="markdownIt-Anchor" href="#smallfuck-有啥用"></a> Smallfuck: 有啥用</h2>
<p>那么，什么是 <a target="_blank" rel="noopener" href="https://esolangs.org/wiki/Smallfuck">Smallfuck</a>？ Smallfuck 是一种极简的编程语言，当内存限制被解除时，它就是图灵完备的。我选择将它在 Rust 类型系统中实现而不是其他图灵完备的语言，就是因为它很简单。</p>
<p>实际上 Smallfuck 非常接近图灵机本身。 根据 Smallfuck 的原始规范声明，它是运行在内存有限的机器上的。然而，如果我们解除这个限制并允许它访问理论上无限的内存数组，那么 Smallfuck 就变成了图灵完备的。所以在这里，我们考虑一种具有无限内存的 Smallfuck 的变体。 本文中 Smallfuck 机器由无限的内存磁带组成，该磁带由包含位的“单元”以及指向该单元的指针组成。</p>
<pre class="line-numbers language-none"><code class="language-none">                 Pointer |
                         v
...000001000111000001000001111...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>Smallfuck 程序是由五个指令组成的字符串：</p>
<pre class="line-numbers language-none"><code class="language-none">&lt; | Pointer decrement
&gt; | Pointer increment
* | Flip current bit
[ | If current bit is 0, jump past the matching ]; else, go to the next instruction
] | Jump back to the matching [ instruction<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>利用这几种指令就能够选择内存单元格并制作循环程序。这是一个简单的示例程序：</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;*&gt;*&gt;*[*&lt;]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这是一个非常简单且完全没用的程序（大多数 Smallfuck 程序都没啥用，这要归因于它完全没有任何类型的 I/O），它只是将指针所指位置的后三位设置为 1，然后使用循环将它们全部置回 0，最后指针停在它开始时候的位置。下面我们来看一下这个过程：</p>
<p>首先，以下是初始状态：</p>
<pre class="line-numbers language-none"><code class="language-none">Instruction pointer
|               Memory pointer
v               v
&gt;*&gt;*&gt;*[*&lt;] | ...0...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>第一条指令将指针向右移动。所有单元格默认为 0：</p>
<pre class="line-numbers language-none"><code class="language-none"> v               v
&gt;*&gt;*&gt;*[*&lt;] | ...00...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>下一条指令是“翻转当前位”指令，因此我们将指针处的位从 0 翻转到 1。</p>
<pre class="line-numbers language-none"><code class="language-none"> v               v
&gt;*&gt;*&gt;*[*&lt;] | ...01...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这种情况发生了 3 次。我们跳过重复来到循环的开头：</p>
<pre class="line-numbers language-none"><code class="language-none">      v            v
&gt;*&gt;*&gt;*[*&lt;] | ...0111...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>现在我们处于循环的开始。 <code>[</code> 指令是说，“如果当前位为零，则跳转到匹配的 <code>]</code>；否则，转到下一条指令。” 当前指针所指是 1，所以我们转到下一条指令。</p>
<pre class="line-numbers language-none"><code class="language-none">       v           v
&gt;*&gt;*&gt;*[*&lt;] | ...0111...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这会将当前位翻转回零；然后，我们将内存指针移回一个位置。</p>
<pre class="line-numbers language-none"><code class="language-none">         v        v
&gt;*&gt;*&gt;*[*&lt;] | ...0110...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>现在我们来到循环结束符<code>]</code>，无条件跳回到循环开始处。</p>
<pre class="line-numbers language-none"><code class="language-none">      v           v
&gt;*&gt;*&gt;*[*&lt;] | ...0110...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>现在我们再次分支。当前单元格为 0 吗？显然不为 0，然后我们继续：</p>
<pre class="line-numbers language-none"><code class="language-none">       v          v
&gt;*&gt;*&gt;*[*&lt;] | ...0110...

        v         v
&gt;*&gt;*&gt;*[*&lt;] | ...0100...

         v       v
&gt;*&gt;*&gt;*[*&lt;] | ...0100...

      v          v
&gt;*&gt;*&gt;*[*&lt;] | ...0100...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在最后一次循环之后，我们结束了：</p>
<pre class="line-numbers language-none"><code class="language-none">      v         v
&gt;*&gt;*&gt;*[*&lt;] | ...0000...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这正是我们开始的地方：所有单元格归零，并且指针位于其起始位置。</p>
<h2 id="smallfuck-在-rust-中的-runtime"><a class="markdownIt-Anchor" href="#smallfuck-在-rust-中的-runtime"></a> Smallfuck 在 Rust 中的 Runtime</h2>
<p>那么在 Rust 中这个简单的实现会是什么样子呢？首先我要介绍我实现的 Smallfuck Runtime 的实现，以验证 Rust type-level 和 Smallfuck 运行时实现是否一致。我们会将 Smallfuck 程序存储为枚举类型定义的 AST 节点，如下形式：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">enum</span> <span class="token type-definition class-name">Program</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Empty</span><span class="token punctuation">,</span>
    <span class="token class-name">Left</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Program</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Right</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Program</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Flip</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Program</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Loop</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token class-name">Program</span><span class="token punctuation">,</span> <span class="token class-name">Program</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这种表示方法对于字符串形式的 Smallfuck 程序并非十分精确，但它更容易理解。我们还需要一个类型来表示正在运行的 Smallfuck 程序的状态：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">State</span> <span class="token punctuation">&#123;</span>
    ptr<span class="token punctuation">:</span> <span class="token keyword">u16</span><span class="token punctuation">,</span>
    bits<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">u16</span><span class="token punctuation">::</span><span class="token constant">MAX</span> <span class="token keyword">as</span> <span class="token keyword">usize</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>尽管要实现图灵完备，我们在技术上需要无限长的磁带，但我们的运行时实现仅仅是为了检查 Rust 类型系统的语义正确性。所以说，这里我们使用一个有限长的磁带作为近似就可以了。通过使用长度为<code>(std::u16::MAX as usize + 1) / 8</code>的<code>bits</code>，我们确保每个<code>u16</code>指针可以指向的范围内都是可用的。现在我们来定义实现 Smallfuck 程序解释器时需要用到的一些操作：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">impl</span> <span class="token class-name">State</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">get_bit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> at<span class="token punctuation">:</span> <span class="token keyword">u16</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>bits<span class="token punctuation">[</span><span class="token punctuation">(</span>at <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>at <span class="token operator">&amp;</span> <span class="token number">0x7</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">get_current_bit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">get_bit</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>ptr<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">flip_current_bit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>bits<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>ptr <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">]</span> <span class="token operator">^=</span> <span class="token number">0x1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>ptr <span class="token operator">&amp;</span> <span class="token number">0x7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是一些标准的位操作。我们将 8 位存储到我们的位数组中的一个单元格中，这样一来要找出给定的指针指向哪个单元格：将指针向右移位三位，然后使用指针的低三位作为单元格内部的索引，就找到了目标 bit 位。</p>
<pre class="line-numbers language-none"><code class="language-none">ptr &#x3D; 0b1100011010011001
Index into the bytes of &#96;bits&#96; --&gt; 1100011010011 \ 001 &lt;-- Which bit in the byte<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>具体来说，这个寻址操作就如是上面的函数<code>get_bit</code>所示，将指针<code>at&gt;&gt;3</code>作为单元格寻址，通过<code>bits[(at &gt;&gt; 3) as usize]</code>取出单元格，然后使用<code>0x7</code>即<code>0b111</code>作为掩码取<code>at</code>的低三位，作为单元格内的偏移量，将<code>0x1</code>左移偏移量，再按位与上单元格就得到了目标bit是1还是0，对应函数返回true和false。同样的<code>flip_current_bit</code>也按相同的方式取出目标bit位，然后异或上<code>0x1</code>，将原bit位取反。</p>
<p>现在我们有了这些原语，让我们继续实现我们的解释器。我们将通过递归调用一个在枚举类型 Program 上进行模式匹配的函数来实现：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">impl</span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">big_step</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> state<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">State</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">use</span> <span class="token keyword">self</span><span class="token punctuation">::</span><span class="token class-name">Program</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

        <span class="token keyword">match</span> <span class="token operator">*</span><span class="token keyword">self</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Empty</span> <span class="token operator">=></span> <span class="token macro property">unimplemented!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Left</span><span class="token punctuation">(</span><span class="token keyword">ref</span> next<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">unimplemented!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Right</span><span class="token punctuation">(</span><span class="token keyword">ref</span> next<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">unimplemented!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Flip</span><span class="token punctuation">(</span><span class="token keyword">ref</span> next<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">unimplemented!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Loop</span><span class="token punctuation">(</span><span class="token keyword">ref</span> body_and_next<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">unimplemented!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>Empty</code> 程序不修改任何状态，因此其实现非常简单：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token class-name">Empty</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>Left</code> 和 <code>Right</code> 只是将指针加/减一。由于我们在简单实现中选择使用有限的内存磁带，因此我们使用 wrapping_add 和 wrapping_sub：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token class-name">Left</span><span class="token punctuation">(</span><span class="token keyword">ref</span> next<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    state<span class="token punctuation">.</span>ptr <span class="token operator">=</span> state<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span><span class="token function">wrapping_sub</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    next<span class="token punctuation">.</span><span class="token function">big_step</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token class-name">Right</span><span class="token punctuation">(</span><span class="token keyword">ref</span> next<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    state<span class="token punctuation">.</span>ptr <span class="token operator">=</span> state<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span><span class="token function">wrapping_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    next<span class="token punctuation">.</span><span class="token function">big_step</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>Flip</code> 非常简单，因为我们已经写了方便的 <code>flip_current_bit</code> 函数：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token class-name">Flip</span><span class="token punctuation">(</span><span class="token keyword">ref</span> next<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    state<span class="token punctuation">.</span><span class="token function">flip_current_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    next<span class="token punctuation">.</span><span class="token function">big_step</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后是循环。我们需要检查当前位。如果是 1，那么我们执行循环体，然后以更新的状态再次执行循环指令。如果为 0，我们继续循环体后的下一条指令：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token class-name">Loop</span><span class="token punctuation">(</span><span class="token keyword">ref</span> body_and_next<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token keyword">ref</span> body<span class="token punctuation">,</span> <span class="token keyword">ref</span> next<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token operator">*</span>body_and_next<span class="token punctuation">;</span>
    <span class="token keyword">if</span> state<span class="token punctuation">.</span><span class="token function">get_current_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        body<span class="token punctuation">.</span><span class="token function">big_step</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">big_step</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        next<span class="token punctuation">.</span><span class="token function">big_step</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意，我们必须对 <code>body_and_next</code> 进行双重解引用，因为我们是将一个元组<code>(Program, Program)</code>装入<code>Box&lt;&gt;</code>中（见 Program 的定义）。我们通过 <code>ref</code> 来避免将 body 和 next 的所有权从 Box 中移走。最终我们为枚举类型 Program 完成的 <code>.big_step()</code> 函数如下所示：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">impl</span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">big_step</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> state<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">State</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">use</span> <span class="token keyword">self</span><span class="token punctuation">::</span><span class="token class-name">Program</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>
    
        <span class="token keyword">match</span> <span class="token operator">*</span><span class="token keyword">self</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Empty</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token class-name">Left</span><span class="token punctuation">(</span><span class="token keyword">ref</span> next<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                state<span class="token punctuation">.</span>ptr <span class="token operator">=</span> state<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span><span class="token function">wrapping_sub</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                next<span class="token punctuation">.</span><span class="token function">big_step</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token class-name">Right</span><span class="token punctuation">(</span><span class="token keyword">ref</span> next<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                state<span class="token punctuation">.</span>ptr <span class="token operator">=</span> state<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span><span class="token function">wrapping_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                next<span class="token punctuation">.</span><span class="token function">big_step</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token class-name">Flip</span><span class="token punctuation">(</span><span class="token keyword">ref</span> next<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                state<span class="token punctuation">.</span><span class="token function">flip_current_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                next<span class="token punctuation">.</span><span class="token function">big_step</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token class-name">Loop</span><span class="token punctuation">(</span><span class="token keyword">ref</span> body_and_next<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token keyword">ref</span> body<span class="token punctuation">,</span> <span class="token keyword">ref</span> next<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token operator">*</span>body_and_next<span class="token punctuation">;</span>
                <span class="token keyword">if</span> state<span class="token punctuation">.</span><span class="token function">get_current_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    body<span class="token punctuation">.</span><span class="token function">big_step</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">big_step</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    next<span class="token punctuation">.</span><span class="token function">big_step</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们不会为<code>State</code>实现任何类型的调试打印，因为我们不需要。当使用我们的实现 Smallfuck 运行时解释器来检查 Rust type-level 解释器时，我们将通过检查 Rust type-level 解释器的输出，和 Smallfuck 运行时解释器输出，的一致性来完成检验。现在，我们终于可以开始做些有趣的事情了！</p>
<h2 id="type-level-smallfuck-in-rust"><a class="markdownIt-Anchor" href="#type-level-smallfuck-in-rust"></a> Type-Level Smallfuck in Rust</h2>
<p>Rust 有一个称为 <em>traits</em> 的特性。 Traits 是一种进行编译时静态分派的方法，也可以用于执行运行时分派（尽管在实践中很少见），这里假设读者知道 Rust 中有这些特征并且已经大量使用过。为了实现 Smallfuck，我们将依赖于被称为 <em>associated types</em> 的特性。</p>
<blockquote>
<p>这里 associated types 可参考：<a target="_blank" rel="noopener" href="https://rustwiki.org/zh-CN/rust-by-example/generics/assoc_items/types.html">关联类型</a> 。</p>
</blockquote>
<h3 id="trait-resolution-and-unification"><a class="markdownIt-Anchor" href="#trait-resolution-and-unification"></a> Trait resolution and unification</h3>
<p>在 Rust 中，为了调用 trait methods 或解析 associated types ，编译器必须经过一个称为 <em>trait resolution</em> 的过程。为了解析一个 trait ，编译器必须寻找一个与所涉及的 types 相对应的 <code>impl</code>。<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Unification_(computer_science)">Unification</a> 是求解 types 之间等式的过程。如果没有解，我们就说 unification 失败了。举个例子：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">trait</span> <span class="token class-name">Foo</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">type</span> <span class="token class-name">Associated</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">></span> <span class="token class-name">Foo</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token keyword">u16</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Associated</span> <span class="token operator">=</span> <span class="token keyword">bool</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">impl</span> <span class="token class-name">Foo</span><span class="token operator">&lt;</span><span class="token keyword">u64</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token keyword">u8</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Associated</span> <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为了解析对一个 associated type （e.g. <code>&lt;F as Foo&lt;T&gt;&gt;::Associated</code>）的引用，Rust 编译器必须找到一个 impl ，这个实现能正确匹配 F 和 T 。假设我们有<code>F == u16</code>和<code>T == u64</code>。如果编译器尝试第二个 impl <code>Foo&lt;u64&gt; for u8</code>，它会发现 F 不匹配 u8，这个实现是不可行的。如果它尝试第一个实现，就得到 <code>F == u16</code>，此时 F 匹配正确。现在我们必须匹配 <code>T == B</code>。这里就是最 magic 的地方。</p>
<p>Rust 编译器将尝试 unify T 和 B 。由于 B 是一个泛型——不是具体类型，它的值可以是 String 或 u64 等等可以被随意赋予。所以现在 B 被 u64 替换，我们有了一个 <code>Foo&lt;u64&gt; for u16</code> 的 impl，这是一个可行的解析。Unification 是一个相当简单的过程：它接受一个可能有泛型的类型，每次它遇到一个尚未分配的泛型，且这个泛型匹配任何其他的类型，就将这个泛型分配给这个类型（即使其他类型也是泛型）。然后，任何时候在 unifies 同一个类型时遇到该泛型，它被其分配的值替换，相反，unification 尝试将分配的类型与另一个类型统一起来。</p>
<p>Unification 操作可以理解为一组“代换”——泛型到类型的映射，这样当你采用类型时，你就在试图 unify 并替换所有出现的泛型，你最终会得到两个相同的类型。下面是一个独立的 unification 示例，尝试使用<code>Foo&lt;Baz, Y&gt;</code> unify <code>Foo&lt;X, Bar&lt;u16, Z&gt;</code> （X，Z 为泛型，Foo，Baz，Bar 为具体类型）：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token class-name">Foo</span><span class="token operator">&lt;</span><span class="token class-name">X</span><span class="token punctuation">,</span> <span class="token class-name">Bar</span><span class="token operator">&lt;</span><span class="token keyword">u16</span><span class="token punctuation">,</span> <span class="token class-name">Z</span><span class="token operator">>></span> <span class="token operator">==</span> <span class="token class-name">Foo</span><span class="token operator">&lt;</span><span class="token class-name">Baz</span><span class="token punctuation">,</span> <span class="token class-name">Y</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>首先，我们检查类型的头部——我们得到 Foo vs. Foo ，并没有失败。如果我们有，比如说，<code>Foo == Bar</code> 那么 unification 就直接失败了。接下来，我们将其分解为两个子问题。我们知道 <code>Foo&lt;A, B&gt; == Foo&lt;C, D&gt;</code> 当且仅当 <code>A == C</code> 和 <code>B == D</code>：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token class-name">X</span> <span class="token operator">==</span> <span class="token class-name">Baz</span><span class="token punctuation">,</span> <span class="token class-name">Bar</span><span class="token operator">&lt;</span><span class="token keyword">u16</span><span class="token punctuation">,</span> <span class="token class-name">Z</span><span class="token operator">></span> <span class="token operator">==</span> <span class="token class-name">Y</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们现在已经解决了一个变量——X，它有一个明确定义的值：Baz 。可以将这个泛型和类型之间的关系添加到我们的代换表中，<code>[X -&gt; Baz]</code>。然后，我们将该代换表应用于第二项 <code>Bar&lt;u16, Z&gt; == Y</code>。因为代换表里没有出现 X，所以什么也没有发生。然后，我们得到了 Y 的替换方案。此时，代换表：<code>[X -&gt; Baz, Y -&gt; Bar&lt;u16, Z&gt;]</code>。让我们观察当我们将其应用于我们想要检查的原始方程时会发生什么：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token class-name">Foo</span><span class="token operator">&lt;</span><span class="token class-name">X</span><span class="token punctuation">,</span> <span class="token class-name">Bar</span><span class="token operator">&lt;</span><span class="token keyword">u16</span><span class="token punctuation">,</span> <span class="token class-name">Z</span><span class="token operator">>></span> <span class="token operator">==</span> <span class="token class-name">Foo</span><span class="token operator">&lt;</span><span class="token class-name">Baz</span><span class="token punctuation">,</span> <span class="token class-name">Y</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token class-name">X</span> <span class="token punctuation">-></span> <span class="token class-name">Baz</span><span class="token punctuation">,</span> <span class="token class-name">Y</span> <span class="token punctuation">-></span> <span class="token class-name">Bar</span><span class="token operator">&lt;</span><span class="token keyword">u16</span><span class="token punctuation">,</span> <span class="token class-name">Z</span><span class="token operator">></span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>转换为：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token class-name">Foo</span><span class="token operator">&lt;</span><span class="token class-name">Baz</span><span class="token punctuation">,</span> <span class="token class-name">Bar</span><span class="token operator">&lt;</span><span class="token keyword">u16</span><span class="token punctuation">,</span> <span class="token class-name">Z</span><span class="token operator">>></span> <span class="token operator">==</span> <span class="token class-name">Foo</span><span class="token operator">&lt;</span><span class="token class-name">Baz</span><span class="token punctuation">,</span> <span class="token class-name">Bar</span><span class="token operator">&lt;</span><span class="token keyword">u16</span><span class="token punctuation">,</span> <span class="token class-name">Z</span><span class="token operator">>></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个等式方程显然是成立的。这两个变量现在相等了！那么 unification 失败的例子是什么样的？咱们试试吧：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token class-name">Foo</span><span class="token operator">&lt;</span><span class="token class-name">Bar</span><span class="token punctuation">,</span> <span class="token class-name">X</span><span class="token operator">></span> <span class="token operator">==</span> <span class="token class-name">Foo</span><span class="token operator">&lt;</span><span class="token class-name">X</span><span class="token punctuation">,</span> <span class="token class-name">Baz</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这分解为两个等式：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token class-name">Bar</span> <span class="token operator">==</span> <span class="token class-name">X</span><span class="token punctuation">,</span> <span class="token class-name">X</span> <span class="token operator">==</span> <span class="token class-name">Baz</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>所以我们求解第一个方程，得到代换表 <code>[X -&gt; Bar]</code>。应用代换表到 <code>x == Baz</code> 产生了 <code>Bar == Baz</code> 这显然是错误的，unification 失败了——没有可行的解。</p>
<p>Unification 是一个非常有用的过程，实际上存在一种编程语言 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Prolog">Prolog</a> ，它通过逻辑表达式描述程序，其程序的执行过程就是表达式的 unification 的过程。这听起来有点让人摸不着头脑。实际上，如果有一种基于 Unification 的图灵完备语言 Prolog，那么 Rust 的 trait 解析（通过尝试unify trait impl 直到找到可行的实现）似乎也应该是图灵完备的.</p>
<h3 id="computing-with-traits"><a class="markdownIt-Anchor" href="#computing-with-traits"></a> Computing with traits</h3>
<p>现在我们已经完成了样板文件，让我们看看我们如何在 Rust 中实际编写实现Smallfuck。我们将使用我几个月前编写的一个名为 <a target="_blank" rel="noopener" href="https://crates.io/crates/type-operators">type_operators!</a> 的宏，它将 DSL 编译成 Rust struct definitions、trait defination 和 trait impls 的集合。接下来我们首先要来看看<code>type_operators!</code>的实现。</p>
<p>我们将从简单开始，我们如何在 Rust 类型中表示 Smallfuck 状态的位？</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token macro property">type_operators!</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">[</span><span class="token constant">ZZ</span><span class="token punctuation">,</span> <span class="token constant">ZZZ</span><span class="token punctuation">,</span> <span class="token constant">ZZZZ</span><span class="token punctuation">,</span> <span class="token constant">ZZZZZ</span><span class="token punctuation">,</span> <span class="token constant">ZZZZZZ</span><span class="token punctuation">]</span>
    
    concrete <span class="token class-name">Bit</span> <span class="token operator">=></span> <span class="token keyword">bool</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">F</span> <span class="token operator">=></span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token class-name">T</span> <span class="token operator">=></span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里有几点需要注意。第一个就是这个有点奇怪的 list，<code>[ZZ, ZZZ, ZZZZ, ZZZZZ, ZZZZZZ]</code> 。这很难解释，但它与 Rust 宏无法创建唯一类型名称有关。因此，你必须通过提供自己的 list 的方式来解决这个问题。你可以暂时忽略这一点，因为它与实际实现无关。但是， <code>concrete Bit</code> 是我们必须要搞清楚的！</p>
<p><code>type_operators!</code> 接受了两种类型级别的伪数据类型定义：<code>data</code> 和 <code>concrete</code> 。这两个宏关键字的区别在于 <code>type_operators!</code> 生成 traits 以确保你不会与这些 type-level 的数据类型不匹配。上面的宏代码将会编译为以下定义：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token class-name">Bit</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">T</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">F</span><span class="token punctuation">;</span>


<span class="token keyword">impl</span> <span class="token class-name">Bit</span> <span class="token keyword">for</span> <span class="token class-name">T</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">&#123;</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Bit</span> <span class="token keyword">for</span> <span class="token class-name">F</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">&#123;</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>希望你能看明白发生了什么。<code>T</code> 和 <code>F</code> 成了单个的实现了 <code>Bit</code> 的 structs 。<code>Bit</code> 为它们提供了一个 <code>reify()</code> 函数，可让你将类型 <code>T</code> 和 <code>F</code> 转换为相应的布尔表示。所以你可以写 <code>&lt;T as Bit&gt;::reify()</code> 它将返回 true 。这很有用，因为只要你有一个 Bit 类型的变量 <code>B: Bit</code>，你就可以使用 <code>B::reify()</code> 返回其对应的 bool 值。我使用它来将 Smallfuck 解释器的输出转换为可以检查其运行时实现的值。</p>
<p>希望我表达的足够清楚！让我们看看另一个使用 <code>concrete</code> 的定义：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">concrete <span class="token class-name">List</span> <span class="token operator">=></span> <span class="token class-name">BitVec</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Nil</span> <span class="token operator">=></span> <span class="token class-name">BitVec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span> <span class="token operator">=</span> <span class="token class-name">Nil</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token keyword">let</span> <span class="token keyword">mut</span> tail <span class="token operator">=</span> <span class="token class-name">L</span><span class="token punctuation">;</span> tail<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">)</span><span class="token punctuation">;</span> tail <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里有点复杂了。让我们慢慢讲一讲。</p>
<p>这是一个 type-level cons-list 。我们从代码中首先可以看到一对结构类型，<code>Nil</code> 和 <code>Cons</code> ，它们将被宏解析为：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Nil</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Cons</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span> <span class="token operator">=</span> <span class="token class-name">Nil</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token class-name">PhantomData</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>所以，现在我们得到了 bits 和 bits 的 lists 。我们可以构造一个列表<code>[T, F, F]</code>作为<code>Cons&lt;T, Cons&lt;F, Cons&lt;F, Nil&gt;&gt;&gt;</code>。除此之外，宏还使我们获得了一些 traits：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token class-name">List</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">BitVec</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">impl</span> <span class="token class-name">List</span> <span class="token keyword">for</span> <span class="token class-name">Nil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">BitVec</span> <span class="token punctuation">&#123;</span> <span class="token class-name">BitVec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token operator">></span> <span class="token class-name">List</span> <span class="token keyword">for</span> <span class="token class-name">Cons</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">BitVec</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> tail <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">L</span> <span class="token keyword">as</span> <span class="token class-name">List</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tail<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token class-name">B</span> <span class="token keyword">as</span> <span class="token class-name">Bit</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tail
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>所以要注意的一件事是，我们写的调用宏的代码中：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span> <span class="token operator">=</span> <span class="token class-name">Nil</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token keyword">let</span> <span class="token keyword">mut</span> tail <span class="token operator">=</span> <span class="token class-name">L</span><span class="token punctuation">;</span> tail<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">)</span><span class="token punctuation">;</span> tail <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>它会产生一种语法糖，其中 L 和 B 被自动具体化为具体类型，然后绑定到这些类型中。这是为了绕过 macro hygiene 的一些限制，并允许用户实际使用这些值。</p>
<p>所以希望现在你已经弄清楚了，让我们看看我们实现 Smallfuck 将使用的最后两个使用 <code>concrete</code> 的定义：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">concrete <span class="token class-name">ProgramTy</span> <span class="token operator">=></span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Empty</span> <span class="token operator">=></span> <span class="token class-name">Program</span><span class="token punctuation">::</span><span class="token class-name">Empty</span><span class="token punctuation">,</span>
    <span class="token class-name">Left</span><span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span> <span class="token operator">=</span> <span class="token class-name">Empty</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">Program</span><span class="token punctuation">::</span><span class="token class-name">Left</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Right</span><span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span> <span class="token operator">=</span> <span class="token class-name">Empty</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">Program</span><span class="token punctuation">::</span><span class="token class-name">Right</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Flip</span><span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span> <span class="token operator">=</span> <span class="token class-name">Empty</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">Program</span><span class="token punctuation">::</span><span class="token class-name">Flip</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Loop</span><span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span> <span class="token operator">=</span> <span class="token class-name">Empty</span><span class="token punctuation">,</span> <span class="token class-name">Q</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span> <span class="token operator">=</span> <span class="token class-name">Empty</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">Program</span><span class="token punctuation">::</span><span class="token class-name">Loop</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">,</span> <span class="token class-name">Q</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

concrete <span class="token class-name">StateTy</span> <span class="token operator">=></span> <span class="token class-name">StateTyOut</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">St</span><span class="token punctuation">(</span><span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> bits <span class="token operator">=</span> <span class="token class-name">L</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> loc <span class="token operator">=</span> bits<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bits<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bits<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">StateTyOut</span> <span class="token punctuation">&#123;</span>
            loc<span class="token punctuation">:</span> loc<span class="token punctuation">,</span>
            bits<span class="token punctuation">:</span> bits<span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>希望你现在已经弄清楚了所有的模式。以下是一个完整的清单，展示了所有这些使用 <code>type_operators!</code> 宏的定义是如何编译成 Rust structs， traits， 和 impls ：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// `Bit` trait and `T` and `F` types.</span>

<span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token class-name">Bit</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">F</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">T</span><span class="token punctuation">;</span>


<span class="token keyword">impl</span> <span class="token class-name">Bit</span> <span class="token keyword">for</span> <span class="token class-name">F</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">&#123;</span>
        <span class="token boolean">false</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Bit</span> <span class="token keyword">for</span> <span class="token class-name">T</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">&#123;</span>
        <span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">// `List` trait and `Nil` and `Cons&lt;H, T>` types.</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token class-name">List</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">BitVec</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Nil</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Cons</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span> <span class="token operator">=</span> <span class="token class-name">Nil</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token class-name">PhantomData</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">PhantomData</span><span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">impl</span> <span class="token class-name">List</span> <span class="token keyword">for</span> <span class="token class-name">Nil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">BitVec</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">BitVec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token operator">></span> <span class="token class-name">List</span> <span class="token keyword">for</span> <span class="token class-name">Cons</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token attribute attr-name">#[allow(non_snake_case)]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">BitVec</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token class-name">B</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token class-name">L</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> tail <span class="token operator">=</span> <span class="token class-name">L</span><span class="token punctuation">;</span>
            tail<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            tail
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">// `ProgramTy` trait and `Empty`, `Left&lt;P>`, `Right&lt;P>`, `Flip&lt;P>`, and `Loop&lt;P, Q>` types.</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token class-name">ProgramTy</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Program</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Empty</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Left</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span> <span class="token operator">=</span> <span class="token class-name">Empty</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token class-name">PhantomData</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Right</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span> <span class="token operator">=</span> <span class="token class-name">Empty</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token class-name">PhantomData</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Flip</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span> <span class="token operator">=</span> <span class="token class-name">Empty</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token class-name">PhantomData</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Loop</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span> <span class="token operator">=</span> <span class="token class-name">Empty</span><span class="token punctuation">,</span> <span class="token class-name">Q</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span> <span class="token operator">=</span> <span class="token class-name">Empty</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token class-name">PhantomData</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">PhantomData</span><span class="token operator">&lt;</span><span class="token class-name">Q</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">impl</span> <span class="token class-name">ProgramTy</span> <span class="token keyword">for</span> <span class="token class-name">Empty</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Program</span><span class="token punctuation">::</span><span class="token class-name">Empty</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token operator">></span> <span class="token class-name">ProgramTy</span> <span class="token keyword">for</span> <span class="token class-name">Left</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token attribute attr-name">#[allow(non_snake_case)]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token class-name">P</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Program</span><span class="token punctuation">::</span><span class="token class-name">Left</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token operator">></span> <span class="token class-name">ProgramTy</span> <span class="token keyword">for</span> <span class="token class-name">Right</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token attribute attr-name">#[allow(non_snake_case)]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token class-name">P</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Program</span><span class="token punctuation">::</span><span class="token class-name">Right</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token operator">></span> <span class="token class-name">ProgramTy</span> <span class="token keyword">for</span> <span class="token class-name">Flip</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token attribute attr-name">#[allow(non_snake_case)]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token class-name">P</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Program</span><span class="token punctuation">::</span><span class="token class-name">Flip</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">Q</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token operator">></span> <span class="token class-name">ProgramTy</span> <span class="token keyword">for</span> <span class="token class-name">Loop</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">,</span> <span class="token class-name">Q</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token attribute attr-name">#[allow(non_snake_case)]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Program</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token class-name">P</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token class-name">Q</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">Q</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Program</span><span class="token punctuation">::</span><span class="token class-name">Loop</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">,</span> <span class="token class-name">Q</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">// `StateTy` trait and `St` type.</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token class-name">StateTy</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">StateTyOut</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token class-name">PhantomData</span><span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">PhantomData</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">PhantomData</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token operator">></span> <span class="token class-name">StateTy</span> <span class="token keyword">for</span> <span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token attribute attr-name">#[allow(non_snake_case)]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">StateTyOut</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token class-name">L</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token class-name">C</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token class-name">R</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> bits <span class="token operator">=</span> <span class="token class-name">L</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> loc <span class="token operator">=</span> bits<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bits<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bits<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StateTyOut</span> <span class="token punctuation">&#123;</span>
                loc<span class="token punctuation">:</span> loc<span class="token punctuation">,</span>
                bits<span class="token punctuation">:</span> bits<span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>from: <a target="_blank" rel="noopener" href="https://gist.github.com/sdleffler/46700a8add454bc23cdb399a766cb273#file-rust-smallfuck-concretes-rs">https://gist.github.com/sdleffler/46700a8add454bc23cdb399a766cb273#file-rust-smallfuck-concretes-rs</a></p>
</blockquote>
<p>从上面的代码可见 <code>ProgramTy</code> 相当简单，希望你现在明白为什么我选择将 Smallfuck 程序的运行时编码为 AST 的形式—— 为了尽可能清晰地反映 Rust type-level encoding。 <code>StateTy</code>  trait 下的 St 类型是一个 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Zipper_(data_structure)">zipper list</a> ，同时表示 Smallfuck 解释器的指针位置和内存。 <code>L</code> 和 <code>R</code> 列表表示 <code>C</code> 两侧的内存，<code>C</code> 是指针下的当前位。</p>
<p>现在我们可以看看最有趣的部分——Smallfuck 解释器的实际实现。它由一个 trait 和十几个 impl 组成。以下是 <code>type_operators!</code> 宏中的代码：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token punctuation">(</span><span class="token class-name">Run</span><span class="token punctuation">)</span> <span class="token class-name">Running</span><span class="token punctuation">(</span><span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">StateTy</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name">StateTy</span> <span class="token punctuation">&#123;</span>
    <span class="token function">forall</span> <span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">Left</span> <span class="token class-name">P</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">Nil</span> <span class="token class-name">C</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">(</span># <span class="token class-name">P</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">Nil</span> <span class="token class-name">F</span> <span class="token punctuation">(</span><span class="token class-name">Cons</span> <span class="token class-name">C</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">forall</span> <span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">Right</span> <span class="token class-name">P</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">L</span> <span class="token class-name">C</span> <span class="token class-name">Nil</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">(</span># <span class="token class-name">P</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token punctuation">(</span><span class="token class-name">Cons</span> <span class="token class-name">C</span> <span class="token class-name">L</span><span class="token punctuation">)</span> <span class="token class-name">F</span> <span class="token class-name">Nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">forall</span> <span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">Left</span> <span class="token class-name">P</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token punctuation">(</span><span class="token class-name">Cons</span> <span class="token class-name">N</span> <span class="token class-name">L</span><span class="token punctuation">)</span> <span class="token class-name">C</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">(</span># <span class="token class-name">P</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">L</span> <span class="token class-name">N</span> <span class="token punctuation">(</span><span class="token class-name">Cons</span> <span class="token class-name">C</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">Right</span> <span class="token class-name">P</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">L</span> <span class="token class-name">C</span> <span class="token punctuation">(</span><span class="token class-name">Cons</span> <span class="token class-name">N</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">(</span># <span class="token class-name">P</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token punctuation">(</span><span class="token class-name">Cons</span> <span class="token class-name">C</span> <span class="token class-name">L</span><span class="token punctuation">)</span> <span class="token class-name">N</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">forall</span> <span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">Flip</span> <span class="token class-name">P</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">L</span> <span class="token class-name">F</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">(</span># <span class="token class-name">P</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">L</span> <span class="token class-name">T</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">Flip</span> <span class="token class-name">P</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">L</span> <span class="token class-name">T</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">(</span># <span class="token class-name">P</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">L</span> <span class="token class-name">F</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">forall</span> <span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">Q</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">Loop</span> <span class="token class-name">P</span> <span class="token class-name">Q</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">L</span> <span class="token class-name">F</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">(</span># <span class="token class-name">Q</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">L</span> <span class="token class-name">F</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">Loop</span> <span class="token class-name">P</span> <span class="token class-name">Q</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">L</span> <span class="token class-name">T</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">(</span># <span class="token punctuation">(</span><span class="token class-name">Loop</span> <span class="token class-name">P</span> <span class="token class-name">Q</span><span class="token punctuation">)</span> <span class="token punctuation">(</span># <span class="token class-name">P</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">L</span> <span class="token class-name">T</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">forall</span> <span class="token punctuation">(</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">StateTy</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">[</span><span class="token class-name">Empty</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token class-name">S</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这些使用宏的代码将编译成一大堆东西。首先来说有一个 trait ，如下代码所示。</p>
<p>这就是奇怪的 gensym list 发挥作用的地方。由于 gensyms 只在这里使用，它们不会与用户编写的任何内容发生冲突，因为这里没有写入任何涉及泛型的内容。由于写 <code>ZZ</code>, <code>ZZZ</code> 等是一件痛苦的事情，这里我选择忽略，不过多叙述我实际放到 gensym list 中的东西，只是简单的把它写好就得了。</p>
<blockquote>
<p>上面一段并不重要，是原作者的自言自语，如果需要可以自行了解 Rust 的宏生成系统.</p>
</blockquote>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">StateTy</span><span class="token operator">></span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Output</span><span class="token punctuation">:</span> <span class="token class-name">StateTy</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">pub</span> <span class="token keyword">type</span> <span class="token class-name">Run</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">StateTy</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">P</span> <span class="token keyword">as</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">>></span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>(Run) Running(ProgramTy, StateTy): StateTy</code> 成了一个 type-level 函数，输入参数是实现了 <code>ProgramTy</code> 和 <code>StateTy</code> 的两种 trait 的类型，输出是实现了 <code>StateTy</code> trait 的类型。</p>
<p>现在来看看里面的东西。让我们先看一个简单的定义：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token function">forall</span> <span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">Left</span> <span class="token class-name">P</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">Nil</span> <span class="token class-name">C</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">(</span># <span class="token class-name">P</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">Nil</span> <span class="token class-name">F</span> <span class="token punctuation">(</span><span class="token class-name">Cons</span> <span class="token class-name">C</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>它编译为一个 trait impl ，如下所示：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token operator">></span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">Nil</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span> <span class="token keyword">for</span> <span class="token class-name">Left</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token operator">></span>
    <span class="token keyword">where</span> <span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">Nil</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token class-name">Cons</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">P</span> <span class="token keyword">as</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">Nil</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token class-name">Cons</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span><span class="token operator">>></span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>(# P (St Nil F (Cons C R)))</code> 的意思是：“递归地‘调用’带有参数 <code>P (St Nil F (Cons C R))</code> 的 type-level 函数。” <code>type_operators!</code> 使用 lisp-like DSL 来简化解析； 写作 <code>(A B C)</code> ，编译为类型： <code>A&lt;B, C&gt;</code> 。 ‘# function’ 在 <code>type_operators!</code> 中是特殊的语法，因为必须追踪 ‘#’ 的使用情况，具体来说：每当调用 ‘#’ 时，必须在 where 子句中添加一个约束。你可以通过上面的示例看到这种用宏生成代码的动作是如何进行的。</p>
<p>现在类型级函数定义的语义已经明确了，我们来看看 Smallfuck 是怎么定义的。我们有四种不同的定义来处理 <code>Left</code> 和 <code>Right</code>指令：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token function">forall</span> <span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">Left</span> <span class="token class-name">P</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">Nil</span> <span class="token class-name">C</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">(</span># <span class="token class-name">P</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">Nil</span> <span class="token class-name">F</span> <span class="token punctuation">(</span><span class="token class-name">Cons</span> <span class="token class-name">C</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token function">forall</span> <span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">Right</span> <span class="token class-name">P</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">L</span> <span class="token class-name">C</span> <span class="token class-name">Nil</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">(</span># <span class="token class-name">P</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token punctuation">(</span><span class="token class-name">Cons</span> <span class="token class-name">C</span> <span class="token class-name">L</span><span class="token punctuation">)</span> <span class="token class-name">F</span> <span class="token class-name">Nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token function">forall</span> <span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">Left</span> <span class="token class-name">P</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token punctuation">(</span><span class="token class-name">Cons</span> <span class="token class-name">N</span> <span class="token class-name">L</span><span class="token punctuation">)</span> <span class="token class-name">C</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">(</span># <span class="token class-name">P</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">L</span> <span class="token class-name">N</span> <span class="token punctuation">(</span><span class="token class-name">Cons</span> <span class="token class-name">C</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">Right</span> <span class="token class-name">P</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">L</span> <span class="token class-name">C</span> <span class="token punctuation">(</span><span class="token class-name">Cons</span> <span class="token class-name">N</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">(</span># <span class="token class-name">P</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token punctuation">(</span><span class="token class-name">Cons</span> <span class="token class-name">C</span> <span class="token class-name">L</span><span class="token punctuation">)</span> <span class="token class-name">N</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第一个定义了当指针向左移动时会发生什么，但我们的拉链列表（zipper list）中左侧的 cons-list 是空的。我们必须创建一个新的 <code>F</code> bit（表示 0），并将当前位移动到右侧的 cons-list 中。左侧的 cons-list 保持为 <code>Nil</code>。</p>
<p>这里的第二个定义同上，现在是指针必须向右移动而右侧的 cons-list 为 <code>Nil</code> 的情况。</p>
<p>第三和第四个定义分别处理指针向左、右移动，且左、右的 cons-list 分别为 <code>Cons&lt;N, L&gt;</code> 和 <code>Cons&lt;N, R&gt;</code> 的情况。在这种情况下，我们可以从 cons-list 中弹出一个值并将其移动到当前位；然后将当前位压入另一个 cons-list 。下面来形象的说明这个四个过程：</p>
<pre class="line-numbers language-none"><code class="language-none">The zipper list is like this:
[...L...] C [...R...]
Where ...L... represents a list which may be Cons or Nil; we don&#39;t care. It&#39;s
opaque.

[...L..., LN] C [RN, ...R...]
Here is a list where the left-hand list is Cons&lt;LN, L&gt; and the right-hand list
is Cons&lt;RN, R&gt;.

The variables used here are meaningful: L &#x3D; Left, R &#x3D; Right, N &#x3D; Next, C &#x3D; Current.

Pointer moves left, left-hand side is Nil:
[] C [...R...] &#x3D;&gt; [] 0 [C, ...R...]

Pointer moves right, right-hand side is Nil:
[...L...] C [] &#x3D;&gt; [...L..., C] 0 []

Pointer moves left, left-hand side is Cons&lt;N, L&gt;:
[...L..., N] C [...R...] &#x3D;&gt; [...L...] N [C, ...R...]

Pointer moves right, right-hand side is Cons&lt;N, R&gt;:
[...L...] C [N, ...R...] &#x3D;&gt; [...L..., C] N [...R...]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>那么 Rust 究竟是如何“执行”这些向左向右动作的呢？假设当前程序为 <code>Left&lt;P&gt;</code> 当前状态是 <code>St&lt;Nil, F, R&gt;</code>。当我们将它们放入 <code>Run&lt;P, S&gt;</code> type synonym，使其成为 <code>Run&lt;Left&lt;P&gt;, St&lt;Nil, F, R&gt;&gt;</code> 时，我们最终得到 <code>&lt;Left&lt;P&gt; as Running&lt;St&lt;Nil, F, R&gt;&gt;&gt;::Output</code> 。这会使得 Rust 尝试搜索一个 impl 来做 unification 。</p>
<p>我们之前说过，由于 Rust 编写 trait 和 impl 的规则，对于任何给定的类型，Rust 尝试为其寻找 impl 最多只能有一个有效的 impl。 Rust 找到了我们手写的宏编译后会生成的 impl ：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token operator">></span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">Nil</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span> <span class="token keyword">for</span> <span class="token class-name">Left</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token operator">></span>
    <span class="token keyword">where</span> <span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">Nil</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token class-name">Cons</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">P</span> <span class="token keyword">as</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">Nil</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token class-name">Cons</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span><span class="token operator">>></span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>Rust 将 trait 中的 <code>Left&lt;P1&gt;</code> （即宏代码中的 P）与我们要求它 unify 的 <code>Left&lt;P2&gt;</code> 统一起来。 （为 <code>P1</code> 和 <code>P2</code> 是不同的） Rust 将 <code>P1</code> 与 <code>P2</code> 统一起来，统一成功。然后，Rust 将 <code>St&lt;Nil, C, R1&gt;</code> 与 <code>St&lt;Nil, F, R2&gt;</code> 统一起来。这也可以成功； <code>Nil</code> 是具体的类型，<code>Nil == Nil</code> ，这没问题也可以统一。将具体类型 <code>F</code> 分配给泛型 <code>C</code>。最后，泛型 <code>R1</code> 和 <code>R2</code> 统一起来，顺利结束 unification。</p>
<p>现在我们有了代换表 <code>[P1 -&gt; P2, C -&gt; F, R1 -&gt; R2]</code> ，它被替换到上述 trait impl 的主体中。我们最终得到了这个：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">impl</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">Nil</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token constant">R2</span><span class="token operator">>></span> <span class="token keyword">for</span> <span class="token class-name">Left</span><span class="token operator">&lt;</span><span class="token constant">P2</span><span class="token operator">></span>
    <span class="token keyword">where</span> <span class="token constant">P2</span><span class="token punctuation">:</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">Nil</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token class-name">Cons</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token constant">R2</span><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">P2</span> <span class="token keyword">as</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">Nil</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token class-name">Cons</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token constant">R2</span><span class="token operator">>></span><span class="token operator">>></span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>所以宏编译生成后的 “output type” 是 <code>&lt;P2 as Running&lt;St&lt;Nil, F, Cons&lt;F, R2&gt;&gt;&gt;&gt;::Output</code> 。</p>
<p>现在我们已经掌握了宏的运作原理，让我们看看 <code>Running</code> 中 <code>Flip</code> 指令的处理：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token function">forall</span> <span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">Flip</span> <span class="token class-name">P</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">L</span> <span class="token class-name">F</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">(</span># <span class="token class-name">P</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">L</span> <span class="token class-name">T</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">Flip</span> <span class="token class-name">P</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">L</span> <span class="token class-name">T</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">(</span># <span class="token class-name">P</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">L</span> <span class="token class-name">F</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上这部分这相当简单。左右列表根本没有修改。我们在 <code>Flip</code> 指令之后对程序递归调用 <code>Run</code>，并通过模式匹配改变 <code>F -&gt; T</code> 和 <code>T -&gt; F</code> ，结束。</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token function">forall</span> <span class="token punctuation">(</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">Q</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">Loop</span> <span class="token class-name">P</span> <span class="token class-name">Q</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">L</span> <span class="token class-name">F</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">(</span># <span class="token class-name">Q</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">L</span> <span class="token class-name">F</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">Loop</span> <span class="token class-name">P</span> <span class="token class-name">Q</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">L</span> <span class="token class-name">T</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">(</span># <span class="token punctuation">(</span><span class="token class-name">Loop</span> <span class="token class-name">P</span> <span class="token class-name">Q</span><span class="token punctuation">)</span> <span class="token punctuation">(</span># <span class="token class-name">P</span> <span class="token punctuation">(</span><span class="token class-name">St</span> <span class="token class-name">L</span> <span class="token class-name">T</span> <span class="token class-name">R</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>循环指令 <code>Loop&lt;P, Q&gt;</code> 是最复杂的指令。我们通过模式匹配检查当前位。如果它是 <code>F</code> 即 0 ，则在运行时的表达就是：我们递归地运行循环之后的程序部分，也就是跳过循环体。如果它是 <code>T</code> 即 1 ，则在运行时的表达就是：我们进行两次递归调用。第一个通过运行循环体产生一个新状态。然后，我们再次使用新状态运行 <code>Loop&lt;P, Q&gt;</code> 。</p>
<p>现在我们已经完成了所有复杂的部分！最后要处理的指令只是 Empty。 Empty 所做的只是返回未修改的当前状态，而不是递归：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token function">forall</span> <span class="token punctuation">(</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">StateTy</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">[</span><span class="token class-name">Empty</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token class-name">S</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>现在，你已经完成了 type-level 实现 Smallfuck 运行时的所有困难工作。以下是代码，展示了 <code>Running</code> trait 及其 impls 的完整扩展版本：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token punctuation">:</span> <span class="token class-name">StateTy</span><span class="token operator">></span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Output</span><span class="token punctuation">:</span> <span class="token class-name">StateTy</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">pub</span> <span class="token keyword">type</span> <span class="token class-name">Run</span><span class="token operator">&lt;</span><span class="token class-name">A</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">:</span> <span class="token class-name">StateTy</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">A</span> <span class="token keyword">as</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">>></span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token punctuation">;</span>


<span class="token comment">// [(Left P), (St Nil C R)] => (# P (St Nil F (Cons C R)))</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token operator">></span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">Nil</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span> <span class="token keyword">for</span> <span class="token class-name">Left</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token operator">></span>
    <span class="token keyword">where</span> <span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">Nil</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token class-name">Cons</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span><span class="token operator">></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">P</span> <span class="token keyword">as</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">Nil</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token class-name">Cons</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span><span class="token operator">>></span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// [(Right P), (St L C Nil)] => (# P (St (Cons C L) F Nil))</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token operator">></span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">Nil</span><span class="token operator">>></span> <span class="token keyword">for</span> <span class="token class-name">Right</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token operator">></span>
    <span class="token keyword">where</span> <span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">Cons</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token class-name">Nil</span><span class="token operator">>></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">P</span> <span class="token keyword">as</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">Cons</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token class-name">Nil</span><span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// [(Left P), (St (Cons N L) C R)] => (# P (St L N (Cons C R)))</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token operator">></span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">Cons</span><span class="token operator">&lt;</span><span class="token class-name">N</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span> <span class="token keyword">for</span> <span class="token class-name">Left</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token operator">></span>
    <span class="token keyword">where</span> <span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">,</span> <span class="token class-name">Cons</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span><span class="token operator">></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">P</span> <span class="token keyword">as</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">,</span> <span class="token class-name">Cons</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span><span class="token operator">>></span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// [(Right P), (St L C (Cons N R))] => (# P (St (Cons C L) N R))</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">:</span> <span class="token class-name">Bit</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token operator">></span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">Cons</span><span class="token operator">&lt;</span><span class="token class-name">N</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token class-name">Right</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token operator">></span>
    <span class="token keyword">where</span> <span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">Cons</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">P</span> <span class="token keyword">as</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">Cons</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// [(Flip P), (St L F R)] => (# P (St L T R))</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token operator">></span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span> <span class="token keyword">for</span> <span class="token class-name">Flip</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token operator">></span>
    <span class="token keyword">where</span> <span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">P</span> <span class="token keyword">as</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// [(Flip P), (St L T R)] => (# P (St L F R))</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token operator">></span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span> <span class="token keyword">for</span> <span class="token class-name">Flip</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token operator">></span>
    <span class="token keyword">where</span> <span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">P</span> <span class="token keyword">as</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// [(Loop P Q), (St L F R)] => (# Q (St L F R))</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">Q</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token operator">></span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span> <span class="token keyword">for</span> <span class="token class-name">Loop</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">,</span> <span class="token class-name">Q</span><span class="token operator">></span>
    <span class="token keyword">where</span> <span class="token class-name">Q</span><span class="token punctuation">:</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">Q</span> <span class="token keyword">as</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// [(Loop P Q), (St L T R)] => (# (Loop P Q) (# P (St L T R)))</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">Q</span><span class="token punctuation">:</span> <span class="token class-name">ProgramTy</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token operator">></span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span> <span class="token keyword">for</span> <span class="token class-name">Loop</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">,</span> <span class="token class-name">Q</span><span class="token operator">></span>
    <span class="token keyword">where</span> <span class="token class-name">Loop</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">,</span> <span class="token class-name">Q</span><span class="token operator">></span><span class="token punctuation">:</span> <span class="token class-name">Running</span><span class="token operator">&lt;&lt;</span><span class="token class-name">P</span> <span class="token keyword">as</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token operator">></span><span class="token punctuation">,</span>
          <span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">Loop</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">,</span> <span class="token class-name">Q</span><span class="token operator">></span> <span class="token keyword">as</span> <span class="token class-name">Running</span><span class="token operator">&lt;&lt;</span><span class="token class-name">P</span> <span class="token keyword">as</span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token operator">>></span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// [Empty, S] => S</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">StateTy</span><span class="token operator">></span> <span class="token class-name">Running</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token class-name">Empty</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token class-name">S</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>from: <a target="_blank" rel="noopener" href="https://gist.github.com/sdleffler/a432103278432140f84f6b17869f8b52/raw/f69435eb4e3800af4a60f5462b2e3840dd308b90/rust-type-level-smallfuck-running-trait.rs">https://gist.github.com/sdleffler/a432103278432140f84f6b17869f8b52/raw/f69435eb4e3800af4a60f5462b2e3840dd308b90/rust-type-level-smallfuck-running-trait.rs</a></p>
</blockquote>
<h2 id="测试和结论"><a class="markdownIt-Anchor" href="#测试和结论"></a> 测试和结论</h2>
<p>除了 type-level 的实现，还实现了两个宏，<code>sf!</code> 和 <code>sf_test!</code> ，用于测试我们的实现：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// A Smallfuck state which is filled with `F` bits - a clean slate.</span>
<span class="token keyword">pub</span> <span class="token keyword">type</span> <span class="token class-name">Blank</span> <span class="token operator">=</span> <span class="token class-name">St</span><span class="token operator">&lt;</span><span class="token class-name">Nil</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token class-name">Nil</span><span class="token operator">></span><span class="token punctuation">;</span>


<span class="token comment">// Convert nicely formatted Smallfuck into type-encoded Smallfuck.</span>
<span class="token macro property">macro_rules!</span> sf <span class="token punctuation">&#123;</span>
    <span class="token punctuation">(</span><span class="token operator">&lt;</span> $<span class="token punctuation">(</span><span class="token variable">$prog</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">tt</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token class-name">Left</span><span class="token operator">&lt;</span><span class="token macro property">sf!</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$prog</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">></span> $<span class="token punctuation">(</span><span class="token variable">$prog</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">tt</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token class-name">Right</span><span class="token operator">&lt;</span><span class="token macro property">sf!</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$prog</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span> $<span class="token punctuation">(</span><span class="token variable">$prog</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">tt</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token class-name">Flip</span><span class="token operator">&lt;</span><span class="token macro property">sf!</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$prog</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token punctuation">[</span>$<span class="token punctuation">(</span><span class="token variable">$inside</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">tt</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">]</span> $<span class="token punctuation">(</span><span class="token variable">$outside</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">tt</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token class-name">Loop</span><span class="token operator">&lt;</span><span class="token macro property">sf!</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$inside</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token macro property">sf!</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$outside</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token class-name">Empty</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token macro property">macro_rules!</span> sf_test <span class="token punctuation">&#123;</span>
    <span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$test_name</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">ident</span> <span class="token variable">$prog</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">tt</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
         $<span class="token punctuation">(</span>
            <span class="token attribute attr-name">#[test]</span>
            <span class="token keyword">fn</span> <span class="token variable">$test_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">let</span> prog <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token macro property">sf!</span> <span class="token variable">$prog</span> <span class="token keyword">as</span> <span class="token class-name">ProgramTy</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">let</span> typelevel_out <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">Run</span><span class="token operator">&lt;</span><span class="token macro property">sf!</span> <span class="token variable">$prog</span><span class="token punctuation">,</span> <span class="token class-name">Blank</span><span class="token operator">></span> <span class="token keyword">as</span> <span class="token class-name">StateTy</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">reify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> runtime_out <span class="token operator">=</span> prog<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Program: &#123;:?&#125;"</span><span class="token punctuation">,</span> prog<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Type-level output: &#123;:?&#125;"</span><span class="token punctuation">,</span> typelevel_out<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">let</span> offset <span class="token operator">=</span> runtime_out<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span><span class="token function">wrapping_sub</span><span class="token punctuation">(</span>typelevel_out<span class="token punctuation">.</span>loc <span class="token keyword">as</span> <span class="token keyword">u16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> b1<span class="token punctuation">)</span> <span class="token keyword">in</span> typelevel_out<span class="token punctuation">.</span>bits<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">let</span> b2 <span class="token operator">=</span> runtime_out<span class="token punctuation">.</span><span class="token function">get_bit</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token keyword">as</span> <span class="token keyword">u16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wrapping_add</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"[&#123;&#125;] &#123;&#125; == &#123;&#125;"</span><span class="token punctuation">,</span>
                            i<span class="token punctuation">,</span>
                            <span class="token keyword">if</span> b1 <span class="token punctuation">&#123;</span> <span class="token string">"1"</span> <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token string">"0"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                            <span class="token keyword">if</span> b2 <span class="token punctuation">&#123;</span> <span class="token string">"1"</span> <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token string">"0"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>b1<span class="token punctuation">,</span> b2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
         <span class="token punctuation">)</span><span class="token operator">*</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我必须感谢 <a target="_blank" rel="noopener" href="https://github.com/durka">durka</a> 修复了我的 <code>sf!</code> 宏，原本的几乎不能用。非常感谢！</p>
<p>完整源代码还包括两个测试：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token macro property">sf_test!</span> <span class="token punctuation">&#123;</span>
    back_and_forth <span class="token punctuation">&#123;</span>
        <span class="token operator">></span> <span class="token operator">*</span> <span class="token operator">></span> <span class="token operator">*</span> <span class="token operator">></span> <span class="token operator">*</span> <span class="token operator">></span> <span class="token operator">*</span> <span class="token operator">&lt;</span> <span class="token punctuation">[</span> <span class="token operator">*</span> <span class="token operator">&lt;</span> <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
    forth_and_back <span class="token punctuation">&#123;</span>
        <span class="token operator">&lt;</span> <span class="token operator">*</span> <span class="token operator">&lt;</span> <span class="token operator">*</span> <span class="token operator">&lt;</span> <span class="token operator">*</span> <span class="token operator">&lt;</span> <span class="token operator">*</span> <span class="token operator">></span> <span class="token punctuation">[</span> <span class="token operator">*</span> <span class="token operator">></span> <span class="token punctuation">]</span> <span class="token operator">></span> <span class="token operator">></span> <span class="token operator">></span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试只检查了type-level 实现相对于指针位置设置的比特位，但足以让我确定我的实现是正确的。 Smallfuck 非常简单，几乎没有出错的余地；尽管如此，如果有人想贡献更多的测试用例，我很欢迎 <a target="_blank" rel="noopener" href="https://github.com/sdleffler/tarpit-rs">pr</a> 请求。</p>
<p>所以，Rust 的类型系统是图灵完备的。这是什么意思？</p>
<p>老实说，这几乎没有任何意义。类型系统确实可以进入无限循环，但我们已经在类型检查器中有递归限制，所以这个证明几乎没啥用。当然，我们可以在类型系统中编写 Smallfuck 之类的东西。好吧，最后这个还有一点点炫。</p>
<p>在类型检查器达到递归限制的大多数情况下，你的程序会无法编译。只有当你真的很向嘲讽 Rust 的类型系统时，那你可以尝试用它编写非常大的 Smallfuck 程序，此时，你可能会达到递归限制。</p>
<p>如果你正在挑战极限并尝试将整数或其他信息编码为 Rust 中的类型——比如 <a target="_blank" rel="noopener" href="https://crates.io/crates/typenum">typenum、peano、type-level-logic</a>——那么本文的证明会有点用，因为基于本文的证明，如果你搞砸了，那么你最终可能会在类型检查器中产生无限循环。</p>
<p>由于 Peano 问题是不可判定的，如果你真的想以一种甚至可以做逻辑推理的方式滥用一个类型系统，那你就必须有一个图灵完备的类型系统。</p>
<p>为了进一步了解图灵完备性，我建议查看 Glasgow Haskell Compiler 的手册，特别是关于 typeclasses 的扩展，例如 - <code>XUndecidableInstances</code>  。维基百科也有很多关于可计算性理论和逻辑科学的学习资料。</p>
<p>最后，该项目的完整源代码可在此处获取，位于 GitHub 上。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/sdleffler/tarpit-rs">https://github.com/sdleffler/tarpit-rs</a></p>
<p>原文写于 <em>March 7, 2017</em>，翻译于 <em>May 4, 2022</em></p>
<p>翻译用词和表意可能不够精准，如有错误和误翻请联系<a target="_blank" rel="noopener" href="https://github.com/Ch3nYe">Ch3nYe</a>或到<a target="_blank" rel="noopener" href="https://github.com/rustlang-cn/Rustt">Rust中文社区</a>提交pr。</p>

  </div>
  <div>
    
      <div 
        class="post-note note-info copyright" 
        style="margin-top: 42px">
        <p>
          <span style="font-weight: bold;">作者：</span><a 
            target="_blank" 
            rel="nofollow noopener noreferrer" 
            href="/about">
            Ch3nYe
          </a>
        </p>
        <p>
          <span style="font-weight: bold;">文章链接：</span><a 
            target="_blank" 
            rel="nofollow noopener noreferrer" 
            href="https://ch3nye.top/Rust%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%E5%9B%BE%E7%81%B5%E5%AE%8C%E5%A4%87%E7%9A%84%E8%AF%81%E6%98%8E/">
            https://ch3nye.top/Rust%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%E5%9B%BE%E7%81%B5%E5%AE%8C%E5%A4%87%E7%9A%84%E8%AF%81%E6%98%8E/
          </a>
        </p>
        <p><span style="font-weight: bold;">版权声明：</span>本博客所有文章除特别声明外，均采用<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0 协议</a>。转载请注明出处！</p>
      </div>
    
  </div>
</article>
<div class="nav">
  
    <div class="nav-item-prev">
      <a 
        href="/Note-SoK-Demystifying-Binary-Lifters-Through-the-Lens-of-Downstream-Applications/" 
        class="nav-link">
        <i class="iconfont icon-left nav-prev-icon"></i>
        <div>
          <div class="nav-label">上一篇</div>
          
            <div class="nav-title">Note 《SoK Demystifying Binary Lifters Through the Lens of Downstream Applications》 </div>
          
        </div>
      </a>
    </div>
  
  
    <div class="nav-item-next">
      <a 
        href="/%E4%BB%8Epython%E8%B0%83%E7%94%A8rust-%E4%BD%BF%E7%94%A8rust%E5%8A%A0%E9%80%9F%E4%BD%A0%E7%9A%84python%E4%BB%A3%E7%A0%81/" 
        class="nav-link">
        <div>
          <div class="nav-label">下一篇</div>
          
            <div class="nav-title">从python调用rust-使用rust加速你的python代码 </div>
          
        </div>
        <i class="iconfont icon-right nav-next-icon"></i>
      </a>
    </div>
  
</div>

  <div 
    class="card card-content comment-card" 
    style="margin-top: 16px;">
    <div class="comment-card-title">评论</div>
    
  <div id="gitalk-container"></div>
  
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

  
<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>

  
<script src="/js/lib/md5.min.js"></script>

  <script>
    var gitalk = new Gitalk({
      clientID: '049b30eb10ea05082ef1',
      clientSecret: 'c33ad95041c69907b3136b895008320f000987db',
      repo: 'Ch3nYe.github.io',
      owner: 'Ch3nYe',
      admin: "Ch3nYe",
      id: md5(location.href),
      distractionFreeMode: false,
      language: 'navigator.language || navigator.userLanguage',
      labels: ["Gitalk"],
      perPage: 10
    })

    gitalk.render('gitalk-container')
  </script>

  </div>

<div 
  class="card card-content toc-card" 
  id="mobiletoc">
  <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>目录
</div>
<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#rust%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%E5%9B%BE%E7%81%B5%E5%AE%8C%E5%A4%87%E7%9A%84%E8%AF%81%E6%98%8E"><span class="toc-text"> Rust类型系统图灵完备的证明</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#smallfuck-%E6%9C%89%E5%95%A5%E7%94%A8"><span class="toc-text"> Smallfuck: 有啥用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#smallfuck-%E5%9C%A8-rust-%E4%B8%AD%E7%9A%84-runtime"><span class="toc-text"> Smallfuck 在 Rust 中的 Runtime</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#type-level-smallfuck-in-rust"><span class="toc-text"> Type-Level Smallfuck in Rust</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#trait-resolution-and-unification"><span class="toc-text"> Trait resolution and unification</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#computing-with-traits"><span class="toc-text"> Computing with traits</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%92%8C%E7%BB%93%E8%AE%BA"><span class="toc-text"> 测试和结论</span></a></li></ol></li></ol>
</div></main>
            <aside class="left-column">
              
              <div class="card card-author">
                
  <img 
    src="/images/logo.png" 
    class="author-img"
    width="88"
    height="88"
    alt="author avatar">

<p class="author-name">Ch3nYe</p>
<p class="author-description">如果有文章有任何错误请留言，谢谢🙏</p>
<div class="author-message">
  <a 
    class="author-posts-count" 
    href="/archives">
    <span>49</span>
    <span>文章</span>
  </a>
  <a 
    class="author-categories-count" 
    href="/categories">
    <span>7</span>
    <span>分类</span>
  </a>
  <a 
    class="author-tags-count" 
    href="/tags">
    <span>72</span>
    <span>标签</span>
  </a>
</div>

  <div class="author-card-society">
    
      <div class="author-card-society-icon">
        <a target="_blank" rel="noopener" href="https://github.com/ch3nye/">
          <i class="iconfont icon-github society-icon"></i>
        </a>
      </div>
    
      <div class="author-card-society-icon">
        <a href="mailto:sud0su@163.com">
          <i class="iconfont icon-mail society-icon"></i>
        </a>
      </div>
    
  </div>

              </div>
               <div class="sticky-tablet">
  
  
    <article class="display-when-two-columns spacer">
      <div class="card card-content toc-card">
        <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>目录
</div>
<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#rust%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%E5%9B%BE%E7%81%B5%E5%AE%8C%E5%A4%87%E7%9A%84%E8%AF%81%E6%98%8E"><span class="toc-text"> Rust类型系统图灵完备的证明</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#smallfuck-%E6%9C%89%E5%95%A5%E7%94%A8"><span class="toc-text"> Smallfuck: 有啥用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#smallfuck-%E5%9C%A8-rust-%E4%B8%AD%E7%9A%84-runtime"><span class="toc-text"> Smallfuck 在 Rust 中的 Runtime</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#type-level-smallfuck-in-rust"><span class="toc-text"> Type-Level Smallfuck in Rust</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#trait-resolution-and-unification"><span class="toc-text"> Trait resolution and unification</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#computing-with-traits"><span class="toc-text"> Computing with traits</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%92%8C%E7%BB%93%E8%AE%BA"><span class="toc-text"> 测试和结论</span></a></li></ol></li></ol>
      </div>
    </article>
  
  
  <article class="card card-content categories-widget">
    <div class="categories-card">
  <div class="categories-header">
    <i 
      class="iconfont icon-fenlei" 
      style="padding-right: 2px;">
    </i>分类
  </div>
  <div class="categories-list">
    
      <a href="/categories/%E5%A4%87%E5%BF%98/">
        <div class="categories-list-item">
          备忘
          <span class="categories-list-item-badge">2</span>
        </div>
      </a>
    
      <a href="/categories/%E7%94%9F%E6%B4%BB/">
        <div class="categories-list-item">
          生活
          <span class="categories-list-item-badge">4</span>
        </div>
      </a>
    
      <a href="/categories/%E6%9D%8E%E5%AE%8F%E6%AF%85%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">
        <div class="categories-list-item">
          李宏毅机器学习笔记
          <span class="categories-list-item-badge">15</span>
        </div>
      </a>
    
      <a href="/categories/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/">
        <div class="categories-list-item">
          论文阅读
          <span class="categories-list-item-badge">14</span>
        </div>
      </a>
    
      <a href="/categories/%E5%AE%9E%E6%88%98/">
        <div class="categories-list-item">
          实战
          <span class="categories-list-item-badge">3</span>
        </div>
      </a>
    
      <a href="/categories/%E7%AC%94%E8%AE%B0/">
        <div class="categories-list-item">
          笔记
          <span class="categories-list-item-badge">8</span>
        </div>
      </a>
    
      <a href="/categories/%E7%BF%BB%E8%AF%91/">
        <div class="categories-list-item">
          翻译
          <span class="categories-list-item-badge">3</span>
        </div>
      </a>
    
  </div>
</div>
  </article>
  
  <article class="card card-content tags-widget">
    <div class="tags-card">
  <div class="tags-header">
    <i 
      class="iconfont icon-biaoqian" 
      style="padding-right: 2px;">
    </i>热门标签
  </div>
  <div class="tags-list">
    
      <a 
        href="/tags/%E7%AC%94%E8%AE%B0/" 
        title="笔记">
        <div class="tags-list-item">笔记</div>
      </a>
    
      <a 
        href="/tags/%E8%AE%BA%E6%96%87/" 
        title="论文">
        <div class="tags-list-item">论文</div>
      </a>
    
      <a 
        href="/tags/note/" 
        title="note">
        <div class="tags-list-item">note</div>
      </a>
    
      <a 
        href="/tags/ML/" 
        title="ML">
        <div class="tags-list-item">ML</div>
      </a>
    
      <a 
        href="/tags/Next-Step-of-ML/" 
        title="Next-Step-of-ML">
        <div class="tags-list-item">Next-Step-of-ML</div>
      </a>
    
      <a 
        href="/tags/Android/" 
        title="Android">
        <div class="tags-list-item">Android</div>
      </a>
    
      <a 
        href="/tags/Binary/" 
        title="Binary">
        <div class="tags-list-item">Binary</div>
      </a>
    
      <a 
        href="/tags/%E6%80%BB%E7%BB%93/" 
        title="总结">
        <div class="tags-list-item">总结</div>
      </a>
    
      <a 
        href="/tags/Rust/" 
        title="Rust">
        <div class="tags-list-item">Rust</div>
      </a>
    
      <a 
        href="/tags/Deep-Learning/" 
        title="Deep-Learning">
        <div class="tags-list-item">Deep-Learning</div>
      </a>
    
      <a 
        href="/tags/%E7%BF%BB%E8%AF%91/" 
        title="翻译">
        <div class="tags-list-item">翻译</div>
      </a>
    
      <a 
        href="/tags/%E5%AD%A6%E4%B9%A0/" 
        title="学习">
        <div class="tags-list-item">学习</div>
      </a>
    
      <a 
        href="/tags/%E5%AE%9E%E6%88%98/" 
        title="实战">
        <div class="tags-list-item">实战</div>
      </a>
    
      <a 
        href="/tags/crack/" 
        title="crack">
        <div class="tags-list-item">crack</div>
      </a>
    
      <a 
        href="/tags/Reassignment/" 
        title="Reassignment">
        <div class="tags-list-item">Reassignment</div>
      </a>
    
      <a 
        href="/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/" 
        title="二进制">
        <div class="tags-list-item">二进制</div>
      </a>
    
  </div>
</div>
  </article>
  
  
</div>
            </aside>
            <aside class="right-column">
              <div class="sticky-widescreen">
  
  
    <article class="card card-content toc-card">
      <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>目录
</div>
<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#rust%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%E5%9B%BE%E7%81%B5%E5%AE%8C%E5%A4%87%E7%9A%84%E8%AF%81%E6%98%8E"><span class="toc-text"> Rust类型系统图灵完备的证明</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#smallfuck-%E6%9C%89%E5%95%A5%E7%94%A8"><span class="toc-text"> Smallfuck: 有啥用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#smallfuck-%E5%9C%A8-rust-%E4%B8%AD%E7%9A%84-runtime"><span class="toc-text"> Smallfuck 在 Rust 中的 Runtime</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#type-level-smallfuck-in-rust"><span class="toc-text"> Type-Level Smallfuck in Rust</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#trait-resolution-and-unification"><span class="toc-text"> Trait resolution and unification</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#computing-with-traits"><span class="toc-text"> Computing with traits</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%92%8C%E7%BB%93%E8%AE%BA"><span class="toc-text"> 测试和结论</span></a></li></ol></li></ol>
    </article>
  
  
  <article class="card card-content">
    <div class="recent-posts-card">
  <div class="recent-posts-header">
    <i 
      class="iconfont icon-wenzhang_huaban" 
      style="padding-right: 2px;">
    </i>最近文章
  </div>
  <div class="recent-posts-list">
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2023-03-24</div>
        <a href="/createforkwashbadbeef/"><div class="recent-posts-item-content">How to create a fork to wash the beef?</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2023-01-21</div>
        <a href="/2022%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"><div class="recent-posts-item-content">2022 年终总结</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2022-10-27</div>
        <a href="/%E5%9F%BA%E4%BA%8E%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%9A%84%E5%87%BD%E6%95%B0%E5%90%8D%E6%81%A2%E5%A4%8D%E6%80%BB%E7%BB%93%EF%BC%88%E4%B8%8B%EF%BC%89/"><div class="recent-posts-item-content">基于机器学习的函数名恢复总结（下）</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2022-10-25</div>
        <a href="/%E5%9F%BA%E4%BA%8E%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%9A%84%E5%87%BD%E6%95%B0%E5%90%8D%E6%81%A2%E5%A4%8D%E6%80%BB%E7%BB%93%EF%BC%88%E4%B8%8A%EF%BC%89/"><div class="recent-posts-item-content">基于机器学习的函数名恢复总结（上）</div></a>
      </div>
    
  </div>
</div>
  </article>
  
  
</div>
            </aside>
          </div>
        </div>
      </div>
    </div>
     
    <footer class="footer">
  <div class="footer-container">
    <div>
      <div class="footer-dsc">
        <span>
          Copyright ©
          
            2020 -
          
          2023
        </span>
        &nbsp;
        <a 
          href="/" 
          class="footer-link">
          ch3nye's blog
        </a>
      </div>
    </div>

    
      <div class="footer-dsc">
        
          Powered by
          <a 
            href="https://hexo.io/" 
            class="footer-link" 
            target="_blank" 
            rel="nofollow noopener noreferrer">
            &nbsp;Hexo
          </a>
        
        
          <span>&nbsp;|&nbsp;</span>
        
        
          Theme -
          <a 
            href="https://github.com/theme-kaze" 
            class="footer-link" 
            target="_blank"
            rel="nofollow noopener noreferrer">
            &nbsp;Kaze
          </a>
        
      </div>
    
    
    
    
      <div class="footer-dsc">
        
          本站总访问量<span id="busuanzi_value_site_pv"></span>次
        
        
          <span>&nbsp;|&nbsp;</span>
        
        
          本站总访客数<span id="busuanzi_value_site_uv"></span>次
        
      </div>
      
    
<!-- Default Statcounter code for My Blog https://ch3nye.top -->
<script type="text/javascript">
var sc_project=12696483; 
var sc_invisible=1; 
var sc_security="0f70f90d"; 
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js" async></script>
<noscript><div class="statcounter"><a title="Web Analytics"
href="https://statcounter.com/" target="_blank"><img class="statcounter"
src="https://c.statcounter.com/12696483/0/0f70f90d/1/" alt="Web Analytics"
referrerPolicy="no-referrer-when-downgrade"></a></div></noscript>
<!-- End of Statcounter Code -->
</footer> 
    
  <a 
    role="button" 
    id="scrollbutton" 
    class="basebutton" 
    aria-label="回到顶部">
    <i class="iconfont icon-arrowleft button-icon"></i>
  </a>

<a 
  role="button" 
  id="menubutton"
  aria-label="menu button"
  class="basebutton">
  <i class="iconfont icon-menu button-icon"></i>
</a>
<a 
  role="button" 
  id="popbutton" 
  class="basebutton" 
  aria-label="控制中心">
  <i class="iconfont icon-expand button-icon"></i>
</a>
<a 
  role="button" 
  id="darkbutton" 
  class="basebutton darkwidget" 
  aria-label="夜色模式">
  <i class="iconfont icon-weather button-icon"></i>
</a>
<a 
  role="button" 
  id="searchbutton" 
  class="basebutton searchwidget" 
  aria-label="搜索">
  <i class="iconfont icon-search button-icon"></i>
</a> 
     
     
      

  
  
    
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css">

  
 
     
     
      <script>
  var addImgLayout = function () {
    var img = document.querySelectorAll('.post-content img')
    var i
    for (i = 0; i < img.length; i++) {
      var wrapper = document.createElement('a')
      wrapper.setAttribute('href', img[i].getAttribute('data-src'))
      wrapper.setAttribute('aria-label', 'illustration')
      wrapper.style.cssText =
        'width: 100%; display: flex; justify-content: center;'
      if (img[i].alt) wrapper.dataset.caption = img[i].alt
      wrapper.dataset.nolink = true
      img[i].before(wrapper)
      wrapper.append(img[i])
      var divWrap = document.createElement('div')
      divWrap.classList.add('gallery')
      wrapper.before(divWrap)
      divWrap.append(wrapper)
    }
    baguetteBox.run('.gallery')
  }
</script>
<script>
  loadScript(
    "/js/lib/lightbox/baguetteBox.min.js",
    addImgLayout
  )
</script>
 
     
     
    <script src="/js/main.js"></script> 
    
      <script> 
        loadScript('/js/lib/busuanzi.min.js') 
      </script>
     
    
      <script>
        var addLazyload = function () {
          var observer = lozad('.lozad', {
            load: function (el) {
              el.srcset = el.getAttribute('data-src')
            },
            loaded: function (el) {
              el.classList.add('loaded')
            },
          })
          observer.observe()
        }
      </script>
      <script>
        loadScript('/js/lib/lozad.min.js', addLazyload)
      </script>
     
    
      <script>
        var googleAnalytics = function () {
          window.dataLayer = window.dataLayer || []
          function gtag() {
            dataLayer.push(arguments)
          }
          gtag('js', new Date())
          gtag('config', 'G-WHGL11014T')
        }
    </script>
      <script>
        loadScript(
          'https://www.googletagmanager.com/gtag/js?id=' +
            'G-WHGL11014T',
          googleAnalytics
        )
      </script>
    
    
      <script>
        setTimeout(() => {localSearch("search.json")}, 0)
      </script>
    
  </body>
</html>
