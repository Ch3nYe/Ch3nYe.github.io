<!DOCTYPE html>
<html  lang="zh-CN" >
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color" content="#fff" id="theme-color">
  <meta name="description" content="网络安全 Android ML CTF">
  <link rel="icon" href="/images/logo.png">
  <title>Android HTTPS认证的N种方式和对抗方法总结</title>
  
  
  <meta property="og:title" content="Android HTTPS认证的N种方式和对抗方法总结">
  
  
  <meta property="og:url" content="https://ch3nye.top/Android-HTTPS%E8%AE%A4%E8%AF%81%E7%9A%84N%E7%A7%8D%E6%96%B9%E5%BC%8F%E5%92%8C%E5%AF%B9%E6%8A%97%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/index.html">
  
  
  <meta property="og:img" content="/images/logo.png">
  
  
  <meta property="og:img" content="网络安全 Android ML CTF">
  
  
  <meta property="og:type" content="article">
  <meta property="og:article:published_time" content="2021-05-01">
  <meta property="og:article:modified_time" content="2021-05-04">
  <meta property="og:article:author" content="Ch3nYe">
  
  
  <meta property="og:article:tag" content="Android">
  
  <meta property="og:article:tag" content="笔记">
  
  <meta property="og:article:tag" content="总结">
  
  <meta property="og:article:tag" content="HTTPS">
  
  <meta property="og:article:tag" content="Hook">
  
  <meta property="og:article:tag" content="frida">
  
  <meta property="og:article:tag" content="SSL PINNING">
  
  
  
  
  <script>
    // control reverse button
    var reverseDarkList = {
      dark: 'light',
      light: 'dark'
    };
    var themeColor = {
      dark: '#1c1c1e',
      light: '#fff'
    }
    // get the data of css prefers-color-scheme
    var getCssMediaQuery = function() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };
    // reverse current darkmode setting function
    var reverseDarkModeSetting = function() {
      var setting = localStorage.getItem('user-color-scheme');
      if(reverseDarkList[setting]) {
        setting = reverseDarkList[setting];
      } else if(setting === null) {
        setting = reverseDarkList[getCssMediaQuery()];
      } else {
        return;
      }
      localStorage.setItem('user-color-scheme', setting);
      return setting;
    };
    // apply current darkmode setting
    var setDarkmode = function(mode) {
      var setting = mode || localStorage.getItem('user-color-scheme');
      if(setting === getCssMediaQuery()) {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[setting];
      } else if(reverseDarkList[setting]) {
        document.documentElement.setAttribute('data-user-color-scheme', setting);
        document.getElementById('theme-color').content = themeColor[setting];
      } else {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[getCssMediaQuery()];
      }
    };
    setDarkmode();
  </script>
  <script>
    function loadScript(url, cb) {
      var script = document.createElement('script');
      script.src = url;
      if (cb) script.onload = cb;
      script.async = true;
      document.body.appendChild(script);
    }
  </script>
  
  <link rel="preload" href="//at.alicdn.com/t/font_1946621_f7g5jnuftcf.css" as="style" >
  <link rel="preload" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css" as="style" >
  
  <link rel="preload" href="//cdn.jsdelivr.net/npm/fslightbox@3.1.0/index.min.js" as="script">
  
  
  <link rel="preload" href="/js/lib/lozad.min.js" as="script">
  
  
  
  
  
  <link rel="prefetch" href="//cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" as="script">
  
  
  
  <link rel="prefetch" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" as="script">
  
  
  
  
<link rel="stylesheet" href="/css/main.css">

  
  
<link rel="stylesheet" href="//at.alicdn.com/t/font_1946621_f7g5jnuftcf.css">

  
  
<link rel="stylesheet" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css">

  
  
  
  
  
  <link href="/js/lib/prism/prism-tomorrow.min.css" rel="stylesheet" data-prism="prism-tomorrow">
  
  
  
<link rel="stylesheet" href="/js/lib/prism/prism-line-numbers.min.css">

  
  
  
<meta name="generator" content="Hexo 5.3.0"></head>


<body>
  <div class="wrapper">
    
    <nav class="navbar">
  <div class="navbar-logo">
    <span class="navbar-logo-main">
      
      <img class="navbar-logo-img" src="/images/logo.png" alt="logo">
      
      <span class="navbar-logo-dsc">ch3nye's blog</span>
    </span>
  </div>
  <div class="navbar-menu">
    
    <a href="/" class="navbar-menu-item">
    
    首页
    
    </a>
    
    <a href="/archives" class="navbar-menu-item">
    
    归档
    
    </a>
    
    <a href="/tags" class="navbar-menu-item">
    
    标签
    
    </a>
    
    <a href="/categories" class="navbar-menu-item">
    
    分类
    
    </a>
    
    <a href="/about" class="navbar-menu-item">
    
    关于
    
    </a>
    
    <a href="/links" class="navbar-menu-item">
    
    友链
    
    </a>
    
    <a class="navbar-menu-item darknavbar" id="dark"><i class="iconfont icon-weather"></i></a>
    <a class="navbar-menu-item searchnavbar" id="search"><i class="iconfont icon-search" style="font-size: 1.2rem; font-weight: 400;"></i></a>
  </div>
</nav>
    
    <div id="local-search" style="display: none;">
      <input class="navbar-menu-item" id="search-input" placeholder="请输入搜索内容...">
      <div id="search-content"></div>
    </div>
    
    <div class="section-wrap">
      <div class="container">
        <div class="columns">
          <main class="main-column">
<article class="card card-content">
  <header>
    <h1 class="post-title">
      Android HTTPS认证的N种方式和对抗方法总结
    </h1>
  </header>
  <div class="post-meta post-show-meta">
    <time datetime="2021-04-30T16:00:00.000Z">
      <i class="iconfont icon-calendar" style="margin-right: 2px;"></i>
      <span>2021-05-01</span>
    </time>
    
    <span class="dot"></span>
    
    <a href="/categories/笔记/" class="post-meta-link">笔记</a>
    
    
    
    <span class="dot"></span>
    <span>7k 字</span>
    
  </div>
  
  <div class="post-meta post-show-meta" style="margin-top: -10px;">
    <div style="display: flex; align-items: center;">
      <i class="iconfont icon-biaoqian" style="margin-right: 2px; font-size: 1.15rem;"></i>
      
      
        <a href="/tags/Android/" class="post-meta-link">Android</a>
      
      
      <span class="dot"></span>
      
        <a href="/tags/笔记/" class="post-meta-link">笔记</a>
      
      
      <span class="dot"></span>
      
        <a href="/tags/总结/" class="post-meta-link">总结</a>
      
      
      <span class="dot"></span>
      
        <a href="/tags/HTTPS/" class="post-meta-link">HTTPS</a>
      
      
      <span class="dot"></span>
      
        <a href="/tags/Hook/" class="post-meta-link">Hook</a>
      
      
      <span class="dot"></span>
      
        <a href="/tags/frida/" class="post-meta-link">frida</a>
      
      
      <span class="dot"></span>
      
        <a href="/tags/SSL-PINNING/" class="post-meta-link">SSL PINNING</a>
      
    </div>
  </div>
  
  </header>
  <div id="section" class="post-content">
    <h1 id="android-https认证的n种方式和对抗方法总结"><a class="markdownIt-Anchor" href="#android-https认证的n种方式和对抗方法总结"></a> Android HTTPS认证的N种方式和对抗方法总结</h1>
<h2 id="0x0-前言"><a class="markdownIt-Anchor" href="#0x0-前言"></a> 0x0 前言</h2>
<p><strong>本文将通过一个Demo APP实现Android中各种HTTPS证书认证，并尝试通过各种方式绕过证书校验和证书绑定</strong>。目的是自我总结与知识点回顾，如果你正在学习这方面的知识，那这篇文章能帮助你从实践中体会Android APP中对HTTPS的防抓包技术及其对抗技术。</p>
<h3 id="a-前置知识"><a class="markdownIt-Anchor" href="#a-前置知识"></a> a. 前置知识</h3>
<p>阅读本文之前需要的前置知识：</p>
<ul>
<li>HTTPS
<ul>
<li>加密原理</li>
<li>证书交换和验证原理</li>
</ul>
</li>
<li>Android 开发技能（一点点）</li>
<li>Frida Hook</li>
<li>Android 代理抓包技能</li>
</ul>
<h3 id="b-设备环境"><a class="markdownIt-Anchor" href="#b-设备环境"></a> b. 设备环境：</h3>
<ul>
<li>RedmiK305G Android10(root) with Magisk</li>
<li>代理端BurpSuite Pro v2.0.11 &amp; Fiddler v5.0</li>
<li>PC Windows 10</li>
<li>虚拟机 Kali Linux 2021</li>
<li>frida 14.2.16</li>
</ul>
<h3 id="c-简单配置"><a class="markdownIt-Anchor" href="#c-简单配置"></a> c. 简单配置</h3>
<p>简单介绍一下我的证书配置方法，并不适合所有人，根据自己的设备配置，总而言之目的就是<strong>将代理软件的证书信任为系统证书</strong>。</p>
<ul>
<li>
<p>将Fiddler 证书导入Android 手机，安装为用户证书</p>
</li>
<li>
<p>将BurpSuite 证书导入Android 手机，安装为用户证书</p>
</li>
<li>
<p>Magisk 开启Always Trust User Certificates 模块</p>
</li>
<li>
<p>手机和PC在同一局域网下</p>
</li>
<li>
<p>PC开启代理软件，配置好监听地址和端口</p>
</li>
<li>
<p>手机在WIFI网络中设置代理</p>
</li>
</ul>
<h3 id="d-demo-app"><a class="markdownIt-Anchor" href="#d-demo-app"></a> d. Demo APP</h3>
<p>建议阅读下文代码片段时参考APP源码</p>
<p>APP 源码：<a target="_blank" rel="noopener" href="https://github.com/Ch3nYe/httpstest">Ch3nYe/httpstest: Android APP for https test (github.com)</a></p>
<p>APP Demo 截图：</p>
<p><img src="/images/image-20210430205919949.png" alt="image-20210430205919949" / srcset="/images/LoadingImage.gif" data-src="/images/image-20210430205919949.png" class="lozad post-image"></p>
<h2 id="0x1-http-直连"><a class="markdownIt-Anchor" href="#0x1-http-直连"></a> 0x1 HTTP 直连</h2>
<p>本文中使用的https访问组件是okhttp3，直接访问http协议的url就可以了。不需要进行任何多余的配置，只需要配置好代理，http流量会被代理软件抓到。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*
* http协议
*/</span>
button_http_connect<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token annotation punctuation">@RequiresApi</span><span class="token punctuation">(</span>api <span class="token operator">=</span> <span class="token class-name">Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N</span><span class="token punctuation">)</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">OkHttpClient</span> mClient <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">"http://www.vulnweb.com/"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                message<span class="token punctuation">.</span>what <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Response</span> response <span class="token operator">=</span> mClient<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    message<span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token string">"http connect access vulnweb.com success"</span><span class="token punctuation">;</span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"http connect access vulnweb.com success return code:"</span><span class="token operator">+</span>response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    message<span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token string">"http connect access vulnweb.com failed"</span><span class="token punctuation">;</span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"http connect access vulnweb.com failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>成功访问时，APP界面上会显示<code>http connect access vulnweb.com success</code></p>
<p>AS(AndroidStudio)中查看日志会看到打印类似 <code>2021-04-30 21:25:38.888 8351-8516/com.example.httpstest D/[+]MainActivity: http connect access vulnweb.com success return code:200</code></p>
<p>上述代码中的message对象的目的是：使用Binder服务从子线程，将HTTP/HTTPS请求结果发送到主线程以改变UI。处理函数Handler的实现如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 注册Handler处理从thread中返回的url请求结果</span>
<span class="token annotation punctuation">@SuppressLint</span><span class="token punctuation">(</span><span class="token string">"HandlerLeak"</span><span class="token punctuation">)</span> <span class="token keyword">final</span> <span class="token class-name">Handler</span> mHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 处理消息</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
                textView<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CharSequence</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="0x2-https-忽略证书验证"><a class="markdownIt-Anchor" href="#0x2-https-忽略证书验证"></a> 0x2 HTTPS 忽略证书验证</h2>
<p>正常人不会忽略证书验证，写这个功能纯粹是为了实验而实验。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*
* https协议
* 忽略证书验证
*/</span>
button_https_connect_without_ca<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token annotation punctuation">@RequiresApi</span><span class="token punctuation">(</span>api <span class="token operator">=</span> <span class="token class-name">Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N</span><span class="token punctuation">)</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">OkHttpClient</span> mClient <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sslSocketFactory</span><span class="token punctuation">(</span><span class="token class-name">HttpsTrustAllCerts</span><span class="token punctuation">.</span><span class="token function">createSSLSocketFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">HttpsTrustAllCerts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hostnameVerifier</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpsTrustAllCerts<span class="token punctuation">.</span>TrustAllHostnameVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">"https://www.baidu.com/?q=trustAllCerts"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                message<span class="token punctuation">.</span>what <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Response</span> response <span class="token operator">=</span> mClient<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    message<span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token string">"https connect without ca success"</span><span class="token punctuation">;</span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"https connect without ca success return code:"</span><span class="token operator">+</span>response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    message<span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token string">"https connect without ca failed"</span><span class="token punctuation">;</span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"https connect without ca failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>HttpsTrustAllCerts对象实现如下，重写checkClientTrusted、checkServerTrusted方法，使其验证逻辑为空，重写域名验证器TrustAllHostnameVerifier 的verify方法，总是返回true，达到信任所有证书的效果:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpsTrustAllCerts</span> <span class="token keyword">implements</span> <span class="token class-name">X509TrustManager</span> <span class="token punctuation">&#123;</span>


    <span class="token annotation punctuation">@SuppressLint</span><span class="token punctuation">(</span><span class="token string">"TrustAllX509TrustManager"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkClientTrusted</span><span class="token punctuation">(</span><span class="token class-name">X509Certificate</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chain<span class="token punctuation">,</span> <span class="token class-name">String</span> authType<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CertificateException</span> <span class="token punctuation">&#123;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@SuppressLint</span><span class="token punctuation">(</span><span class="token string">"TrustAllX509TrustManager"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkServerTrusted</span><span class="token punctuation">(</span><span class="token class-name">X509Certificate</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chain<span class="token punctuation">,</span> <span class="token class-name">String</span> authType<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CertificateException</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 验证服务端证书需要重写该函数</span>

    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">X509Certificate</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getAcceptedIssuers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">X509Certificate</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//返回长度为0的数组，相当于return null</span>
    <span class="token punctuation">&#125;</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SSLSocketFactory</span> <span class="token function">createSSLSocketFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// SSLSocketFactory 创建器</span>
        <span class="token class-name">SSLSocketFactory</span> sSLSocketFactory <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">SSLContext</span> sc <span class="token operator">=</span> <span class="token class-name">SSLContext</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"TLS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sc<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TrustManager</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">new</span> <span class="token class-name">HttpsTrustAllCerts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">SecureRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sSLSocketFactory <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">getSocketFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> sSLSocketFactory<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TrustAllHostnameVerifier</span> <span class="token keyword">implements</span> <span class="token class-name">HostnameVerifier</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 域名验证器</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token class-name">SSLSession</span> sslSession<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>忽略证书校验的https请求和使用http协议的请求报文一样，可以通过直接设置网络代理抓包解密明文。</p>
<h2 id="0x3-https-系统证书校验"><a class="markdownIt-Anchor" href="#0x3-https-系统证书校验"></a> 0x3 HTTPS 系统证书校验</h2>
<p>OkHttp3框架发起HTTPS请求时，默认就是使用的系统信任库证书链对服务端返回的证书进行验证，实现如下:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*
* https协议
* 默认证书链校验，只信任系统CA(根证书)
*
* tips: OKHTTP默认的https请求使用系统CA验证服务端证书（Android7.0以下还信任用户证书，Android7.0开始默认只信任系统证书）
*/</span>
button_https_connect_with_system_ca<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token annotation punctuation">@RequiresApi</span><span class="token punctuation">(</span>api <span class="token operator">=</span> <span class="token class-name">Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N</span><span class="token punctuation">)</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">"https://www.baidu.com/?q=defaultCerts"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                message<span class="token punctuation">.</span>what <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Response</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    message<span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token string">"https connect with system ca success"</span><span class="token punctuation">;</span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"https connect with system ca success return code:"</span><span class="token operator">+</span>response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    message<span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token string">"https connect with system ca failed"</span><span class="token punctuation">;</span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"https connect with system ca failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时需要安装代理软件的证书到系统证书目录，前面说过我本机已经配置两个抓包软件的证书到系统证书列表了，所以仍然可以抓包解密明文。</p>
<h2 id="0x4-ssl-pinning代码校验"><a class="markdownIt-Anchor" href="#0x4-ssl-pinning代码校验"></a> 0x4 SSL PINNING（代码校验）</h2>
<p><strong>SSL PINNING 就是说通过客户端检查服务端证书是否真的是服务端证书来判断是否被中间人攻击</strong>。由于客户端需要验证服务端证书的正确性，那大原则上就是说客户端必须要有能判断正确性的依据。对于Android APP来说通常有两种方式：</p>
<ul>
<li>客户端持有证书公钥hash</li>
<li>客户端持有证书文件</li>
</ul>
<p>下面的代码段也是通过这两种方式进行了证书验证。这样代理软件充当服务端的时候发给APP的证书就不能通过SSL PINNING验证。证书的获取方式可以参考代码中的注释。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*
* https协议 SSL Pinning
* 证书公钥绑定：验证证书公钥 baidu.com 使用CertificatePinner
* 证书文件绑定：验证证书文件 bing.com  使用SSLSocketFactory
*/</span>
button_SSL_PINNING_with_key<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token annotation punctuation">@RequiresApi</span><span class="token punctuation">(</span>api <span class="token operator">=</span> <span class="token class-name">Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N</span><span class="token punctuation">)</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">final</span> <span class="token class-name">String</span> CA_DOMAIN <span class="token operator">=</span> <span class="token string">"www.baidu.com"</span><span class="token punctuation">;</span>
                <span class="token comment">//获取目标公钥: openssl s_client -connect www.baidu.com:443 -servername www.baidu.com | openssl x509 -pubkey -noout | openssl rsa -pubin -outform der | openssl dgst -sha256 -binary | openssl enc -base64</span>
                <span class="token keyword">final</span> <span class="token class-name">String</span> CA_PUBLIC_KEY <span class="token operator">=</span> <span class="token string">"sha256//558pd1Y5Vercv1ZoSqOrJWDsh9sTMEolM6T8csLucQ="</span><span class="token punctuation">;</span>
                <span class="token comment">//只校验公钥</span>
                <span class="token class-name">CertificatePinner</span> pinner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CertificatePinner<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>CA_DOMAIN<span class="token punctuation">,</span> CA_PUBLIC_KEY<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">OkHttpClient</span> pClient <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">certificatePinner</span><span class="token punctuation">(</span>pinner<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">"https://www.baidu.com/?q=SSLPinningCode"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                message<span class="token punctuation">.</span>what <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Response</span> response <span class="token operator">=</span> pClient<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    message<span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token string">"https SSL_PINNING_with_key access baidu.com success"</span><span class="token punctuation">;</span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"https SSL_PINNING_with_key access baidu.com success return code:"</span><span class="token operator">+</span>response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    message<span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token string">"https SSL_PINNING_with_key access baidu.com failed"</span><span class="token punctuation">;</span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"https SSL_PINNING_with_key access baidu.com failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>


                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// 获取证书输入流</span>
                    <span class="token comment">// 获取证书 openssl s_client -connect bing.com:443 -servername bing.com | openssl x509 -out bing.pem</span>
                    <span class="token class-name">InputStream</span> openRawResource <span class="token operator">=</span> <span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openRawResource</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>raw<span class="token punctuation">.</span>bing<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//R.raw.bing是bing.com的正确证书，R.raw.bing2_so是hostname=bing.com的so.com的证书，可视为用作测试的虚假bing.com证书</span>
                    <span class="token class-name">Certificate</span> ca <span class="token operator">=</span> <span class="token class-name">CertificateFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"X.509"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">generateCertificate</span><span class="token punctuation">(</span>openRawResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 创建 Keystore 包含我们的证书</span>
                    <span class="token class-name">KeyStore</span> keyStore <span class="token operator">=</span> <span class="token class-name">KeyStore</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">KeyStore</span><span class="token punctuation">.</span><span class="token function">getDefaultType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    keyStore<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    keyStore<span class="token punctuation">.</span><span class="token function">setCertificateEntry</span><span class="token punctuation">(</span><span class="token string">"ca"</span><span class="token punctuation">,</span> ca<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 创建一个 TrustManager 仅把 Keystore 中的证书 作为信任的锚点</span>
                    <span class="token class-name">TrustManagerFactory</span> trustManagerFactory <span class="token operator">=</span> <span class="token class-name">TrustManagerFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">TrustManagerFactory</span><span class="token punctuation">.</span><span class="token function">getDefaultAlgorithm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 建议不要使用自己实现的X509TrustManager，而是使用默认的X509TrustManager</span>
                    trustManagerFactory<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>keyStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 用 TrustManager 初始化一个 SSLContext</span>
                    sslContext <span class="token operator">=</span> <span class="token class-name">SSLContext</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"TLS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//定义：public static SSLContext sslContext = null;</span>
                    sslContext<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> trustManagerFactory<span class="token punctuation">.</span><span class="token function">getTrustManagers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SecureRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token class-name">OkHttpClient</span> pClient2 <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sslSocketFactory</span><span class="token punctuation">(</span>sslContext<span class="token punctuation">.</span><span class="token function">getSocketFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">X509TrustManager</span><span class="token punctuation">)</span> trustManagerFactory<span class="token punctuation">.</span><span class="token function">getTrustManagers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Request</span> request2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">"https://www.bing.com/?q=SSLPinningCAfile"</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Response</span> response2 <span class="token operator">=</span> pClient2<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        message<span class="token punctuation">.</span>obj <span class="token operator">+=</span> <span class="token string">"\nhttps SSL_PINNING_with_CA_file access bing.com success"</span><span class="token punctuation">;</span>
                        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"https SSL_PINNING_with_CA_file access bing.com success return code:"</span><span class="token operator">+</span>response2<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        message<span class="token punctuation">.</span>obj <span class="token operator">+=</span> <span class="token string">"\nhttps SSL_PINNING_with_CA_file access bing.com failed"</span><span class="token punctuation">;</span>
                        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"https SSL_PINNING_with_CA_file access bing.com failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>

                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeyStoreException</span> <span class="token operator">|</span> <span class="token class-name">CertificateException</span> <span class="token operator">|</span> <span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">NoSuchAlgorithmException</span> <span class="token operator">|</span> <span class="token class-name">KeyManagementException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时可以使用Frida对上述证书绑定进行动作Hook，阻断绑定，hook代码在0x-1附录。</p>
<h2 id="0x5-ssl-pinning配置文件"><a class="markdownIt-Anchor" href="#0x5-ssl-pinning配置文件"></a> 0x5 SSL PINNING（配置文件）</h2>
<p>通过<code>res/xml/network_security_config.xml</code>配置文件对证书进行校验是官方推荐使用的方法，配置方式还是可以为两种（同上）</p>
<ul>
<li>
<p>公钥校验</p>
</li>
<li>
<p>证书校验</p>
</li>
</ul>
<p>xml 配置如下所示：</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>network-security-config</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>tools</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/tools<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!--允许http访问--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>base-config</span> <span class="token attr-name">cleartextTrafficPermitted</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">tools:</span>ignore</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>InsecureBaseConfiguration<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token comment">&lt;!--证书校验--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>domain-config</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>domain</span> <span class="token attr-name">includeSubdomains</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>sogou.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>domain</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>trust-anchors</span><span class="token punctuation">></span></span>
            <span class="token comment">&lt;!--获取证书: openssl s_client -connect sogou.com:443 -servername sogou.com | openssl x509 -out sogou.pem--></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>certificates</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@raw/sogou<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>trust-anchors</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>domain-config</span><span class="token punctuation">></span></span>

    <span class="token comment">&lt;!--公钥校验--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>domain-config</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>domain</span> <span class="token attr-name">includeSubdomains</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>zhihu.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>domain</span><span class="token punctuation">></span></span>
        <span class="token comment">&lt;!--zhihu.com公钥校验
        获取公钥: openssl s_client -connect zhihu.com:443 -servername zhihu.com | openssl x509 -pubkey -noout | openssl rsa -pubin -outform der | openssl dgst -sha256 -binary | openssl enc -base64
        --></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pin-set</span> <span class="token attr-name">expiration</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2099-01-01<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">tools:</span>ignore</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>MissingBackupPin<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pin</span> <span class="token attr-name">digest</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SHA-256<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>vzXV96/gpZMyyNNhyTdjtX0/NUVYTtmYqWcVVaUtTdQ=<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pin</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pin-set</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>domain-config</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>network-security-config</span><span class="token punctuation">></span></span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样配置好以后就可以对上述指定的域名进行https访问，将会自动对证书进行校验，请求代码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*
* https协议 SSL PINNING
* 证书绑定验证 配置在 @xml/network_security_config 中
* sogou.com 使用 sogou.pem 验证证书
* so.com 使用 sha256 key 验证
*/</span>
button_SSL_PINNING_with_CA<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token annotation punctuation">@RequiresApi</span><span class="token punctuation">(</span>api <span class="token operator">=</span> <span class="token class-name">Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N</span><span class="token punctuation">)</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">OkHttpClient</span> pClient <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">"https://www.sogou.com/web?query=SSLPinningXML"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Request</span> request2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">"https://www.zhihu.com/"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                message<span class="token punctuation">.</span>what <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Response</span> response <span class="token operator">=</span> pClient<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    message<span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token string">"https SSL_PINNING_with_CA, config in xml with CA.pem file access sogou.com success"</span><span class="token punctuation">;</span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"https SSL_PINNING_with_CA, config in xml with CA.pem file access sogou.com success return code:"</span><span class="token operator">+</span>response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    message<span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token string">"https SSL_PINNING_with_CA, config in xml with CA.pem file access sogou.com failed"</span><span class="token punctuation">;</span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"https SSL_PINNING_with_CA, config in xml with CA.pem file access sogou.com failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Response</span> response <span class="token operator">=</span> pClient<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    message<span class="token punctuation">.</span>obj <span class="token operator">+=</span> <span class="token string">"\nhttps SSL_PINNING_with_CA, config in xml with key access zhihu.com success"</span><span class="token punctuation">;</span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"https SSL_PINNING_with_CA, config in xml with key access zhihu.com success return code:"</span><span class="token operator">+</span>response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    message<span class="token punctuation">.</span>obj <span class="token operator">+=</span> <span class="token string">"\nhttps SSL_PINNING_with_CA, config in xml with key access zhihu.com failed"</span><span class="token punctuation">;</span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"https SSL_PINNING_with_CA, config in xml with key access zhihu.com failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该证书绑定实现，绕过方式同0x4 SSL PINNING（代码校验）可以使用frida hook unpinning。</p>
<h2 id="0x6-https-双向验证"><a class="markdownIt-Anchor" href="#0x6-https-双向验证"></a> 0x6 HTTPS 双向验证</h2>
<p>双向验证，顾名思义就是客户端验证服务器端证书的正确性，服务器端也验证客户端的证书正确性，所以大原则上客户端要持有服务器端证书，服务端也要持有客户端的证书，对于Android APP来说打包发布的时候既要内置一个服务端证书也要生成一个客户端证书给服务器存储起来。这种双向认证非常可以做到非常高的安全性，但是同时服务端要想保持所有服务端的证书比较困难，因此这种方式只适用于某些点对点的高安全性需求的通信场合，对于Android APP来说可能是某类高机密性的内网业务才会使用这种双向HTTPS认证。</p>
<p>接下来我们需要实现一个server模拟HTTPS双向认证。首先通过以下命令生成一对证书。</p>
<p><strong>服务端证书：</strong></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">openssl genrsa -out server-key.key 2048
openssl req -new -out server-req.csr -key server-key.key
openssl x509 -req -in server-req.csr -out server-cert.cer -signkey server-key.key  -CAcreateserial -days 3650<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>客户端证书：</strong></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">openssl genrsa -out client-key.key 2048
openssl req -new -out client-req.csr -key client-key.key
openssl x509 -req -in client-req.csr -out client-cert.cer -signkey client-key.key -CAcreateserial -days 3650<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>生成客户端带密码的p12证书（这步很重要，双向认证的话，浏览器访问时候要导入该证书才行；可能某些Android系统版本请求的时候需要把它转成bks来请求双向认证，我的设备用p12格式是可行的）：</p>
<p><code>openssl pkcs12 -export -clcerts -in client-cert.cer -inkey client-key.key -out client.p12</code></p>
<p>这里你也可以选择使用我生成好的证书，需要使用的证书都在源码certs目录，我的client.p12密码是clientpassword，server证书的密码是serverpassword。</p>
<p><strong>服务端代码：</strong></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> ssl
<span class="token keyword">from</span> http<span class="token punctuation">.</span>server <span class="token keyword">import</span> HTTPServer<span class="token punctuation">,</span> BaseHTTPRequestHandler

<span class="token comment">#服务端证书和私钥</span>
serverCerts <span class="token operator">=</span> <span class="token string">"%s\\certs\\server-cert.cer"</span> <span class="token operator">%</span> os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span>
serverKey <span class="token operator">=</span> <span class="token string">"%s\\certs\\server-key.key"</span> <span class="token operator">%</span> os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#客户端证书</span>
clientCerts <span class="token operator">=</span> <span class="token string">"%s\\certs\\client-cert.cer"</span> <span class="token operator">%</span> os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">RequestHandler</span><span class="token punctuation">(</span>BaseHTTPRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">_writeheaders</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>send_header<span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span><span class="token string">'text/plain'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">do_GET</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_writeheaders<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"OK"</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        port <span class="token operator">=</span> <span class="token number">443</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        port <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    server_address <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span>
    server <span class="token operator">=</span> HTTPServer<span class="token punctuation">(</span>server_address<span class="token punctuation">,</span> RequestHandler<span class="token punctuation">)</span>
    <span class="token comment">#双向校验</span>
    server<span class="token punctuation">.</span>socket <span class="token operator">=</span> ssl<span class="token punctuation">.</span>wrap_socket<span class="token punctuation">(</span>server<span class="token punctuation">.</span>socket<span class="token punctuation">,</span> certfile <span class="token operator">=</span> serverCerts<span class="token punctuation">,</span> server_side <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>  
                               keyfile <span class="token operator">=</span> serverKey<span class="token punctuation">,</span>
                               cert_reqs <span class="token operator">=</span> ssl<span class="token punctuation">.</span>CERT_REQUIRED<span class="token punctuation">,</span>
                               ca_certs <span class="token operator">=</span> clientCerts<span class="token punctuation">,</span>
                               do_handshake_on_connect <span class="token operator">=</span> <span class="token boolean">False</span>
                               <span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Starting server, listen at: %s:%s"</span> <span class="token operator">%</span> server_address<span class="token punctuation">)</span>
    server<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用python启动server，在windows上运行可能报错，大概率是由于防火墙禁止启用443端口。</p>
<p><code>OSError: [WinError 10013] 以一种访问权限不允许的方式做了一个访问套接字的尝试。</code></p>
<p>所以我的方案是在VMware虚拟机中启动这个server，然后再宿主机配置hosts，添加主机域名</p>
<p><code>&lt;虚拟机IP&gt; www.test.com</code></p>
<p>宿主机安装client.p12证书（windows双击安装好方便），然后使用浏览器访问 <a target="_blank" rel="noopener" href="http://www.test.com">www.test.com</a></p>
<p><img src="/images/image-20210430222039858.png" alt="image-20210430222039858" / srcset="/images/LoadingImage.gif" data-src="/images/image-20210430222039858.png" class="lozad post-image"></p>
<p>然后你就选这个，就可以访问了，访问成功会返回OK字样的空白页。服务端日志：</p>
<p><img src="/images/image-20210430222259900.png" alt="image-20210430222259900" / srcset="/images/LoadingImage.gif" data-src="/images/image-20210430222259900.png" class="lozad post-image"></p>
<p>尽管输出ERROR但是还是访问成功了，错误原因应该是证书为自签名证书，客户端并不想认可这个没娘的证书。</p>
<p>如果你能做到这里说明你已经正确实现了HTTPS双向认证，接下来我们要在Android APP上复现。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*
* 双向校验
* 因该测试是自建服务器并自签名，所以需要先在res/xml/network_security_config中配置信任服务端证书
*/</span>
button_https_twoway<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token annotation punctuation">@RequiresApi</span><span class="token punctuation">(</span>api <span class="token operator">=</span> <span class="token class-name">Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N</span><span class="token punctuation">)</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">X509TrustManager</span> trustManager <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">TrustManagerFactory</span> trustManagerFactory <span class="token operator">=</span> <span class="token class-name">TrustManagerFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">TrustManagerFactory</span><span class="token punctuation">.</span><span class="token function">getDefaultAlgorithm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    trustManagerFactory<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">KeyStore</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">TrustManager</span><span class="token punctuation">[</span><span class="token punctuation">]</span> trustManagers <span class="token operator">=</span> trustManagerFactory<span class="token punctuation">.</span><span class="token function">getTrustManagers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>trustManagers<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>trustManagers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">X509TrustManager</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Unexpected default trust managers:"</span> <span class="token operator">+</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>trustManagers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    trustManager <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">X509TrustManager</span><span class="token punctuation">)</span> trustManagers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token class-name">OkHttpClient</span> mClient <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sslSocketFactory</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span><span class="token class-name">ClientSSLSocketFactory</span><span class="token punctuation">.</span><span class="token function">getSocketFactory</span><span class="token punctuation">(</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>trustManager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hostnameVerifier</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostnameVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token class-name">String</span> hostname<span class="token punctuation">,</span> <span class="token class-name">SSLSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">HostnameVerifier</span> hv <span class="token operator">=</span> <span class="token class-name">HttpsURLConnection</span><span class="token punctuation">.</span><span class="token function">getDefaultHostnameVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> hv<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span><span class="token string">"www.test.com"</span><span class="token punctuation">,</span> session<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">"https://www.test.com/?q=TwoWayVerify"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                message<span class="token punctuation">.</span>what <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Response</span> response <span class="token operator">=</span> mClient<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"TestReq"</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">peekBody</span><span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    message<span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token string">"请求成功: "</span> <span class="token operator">+</span> response<span class="token punctuation">.</span><span class="token function">peekBody</span><span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    message<span class="token punctuation">.</span>obj <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getLocalizedMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>network_security_config.xml 中添加配置：</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--证书校验--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>domain-config</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>domain</span> <span class="token attr-name">includeSubdomains</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>www.test.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>domain</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>trust-anchors</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>certificates</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@raw/server_cert<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">tools:</span>ignore</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>NetworkSecurityConfig<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>trust-anchors</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>domain-config</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>server_cert就是server_cert.cer。到这里完成了客户端PIN服务端证书，然后还要在客户端这边写<strong>把客户端证书给服务端验证的代码逻辑</strong>，即ClientSSLSocketFactory的实现：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientSSLSocketFactory</span>  <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> KEY_STORE_PASSWORD <span class="token operator">=</span> <span class="token string">"clientpassword"</span><span class="token punctuation">;</span> <span class="token comment">// 证书密码</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">InputStream</span> client_input<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SSLSocketFactory</span> <span class="token function">getSocketFactory</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//客户端证书</span>
            client_input <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token string">"client.p12"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SSLContext</span> sslContext <span class="token operator">=</span> <span class="token class-name">SSLContext</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"TLS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">KeyStore</span> keyStore <span class="token operator">=</span> <span class="token class-name">KeyStore</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"PKCS12"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyStore<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>client_input<span class="token punctuation">,</span> KEY_STORE_PASSWORD<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">KeyManagerFactory</span> keyManagerFactory <span class="token operator">=</span> <span class="token class-name">KeyManagerFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">KeyManagerFactory</span><span class="token punctuation">.</span><span class="token function">getDefaultAlgorithm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyManagerFactory<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>keyStore<span class="token punctuation">,</span> KEY_STORE_PASSWORD<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sslContext<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>keyManagerFactory<span class="token punctuation">.</span><span class="token function">getKeyManagers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SecureRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> sslContext<span class="token punctuation">.</span><span class="token function">getSocketFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                client_input<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>代码写完了，现在我们来缕一缕：</p>
<p>client app包含server-cert.cer 对服务端证书PIN，这个过程需要验证服务端证书的签发单位是否为合法CA Issuer，但是我们的证书是自签名的，所以就算是不使用代理还是不能通过SSL PINNING，大概率是报错：</p>
<p><code>Caused by: java.security.cert.CertificateException: java.security.cert.CertPathValidatorException: Trust anchor for certification path not found.</code></p>
<p><strong>所以，一开始我们就需要用frida hook启动app，这样跳过app端的证书绑定，才可以继续后面的步骤。</strong></p>
<p>接下来需要配置代理，给代理软件加客户端证书，这里我们使用BurpSuite，Fidller在这个场景不能用：</p>
<p><img src="/images/image-20210430223211340.png" alt="image-20210430223211340" / srcset="/images/LoadingImage.gif" data-src="/images/image-20210430223211340.png" class="lozad post-image"></p>
<p>选择client.p12证书文件，如果你使用我生成的证书文件密码是clientpassword。</p>
<p>此时确认以下条件：</p>
<ul>
<li>[x] 服务端能通过PC浏览器访问</li>
<li>[x] APP 中 client.p12 证书装载成功</li>
<li>[x] APP 通过frida hook spawn模式启动</li>
<li>[x] BurpSuite 加载 client.p12 证书成功</li>
<li>[x] PC 代理软件未开启</li>
<li>[x] PC hosts 中将 <a target="_blank" rel="noopener" href="http://www.test.com">www.test.com</a> 域名定向到正确IP</li>
</ul>
<p>确定没问题以后，点击 HTTPS 双向验证 按钮访问。</p>
<p>最终效果：</p>
<p><img src="/images/image-20210430232813386.png" alt="image-20210430232813386" / srcset="/images/LoadingImage.gif" data-src="/images/image-20210430232813386.png" class="lozad post-image"></p>
<p>APP 页面上显示：请求成功: 200</p>
<blockquote>
<p>碎碎念：</p>
<p>可以把server-cert.cer 连带 server-key.key 导出一份可以装载的证书，这样就可以把这个证书加到系统证书列表中，应该可以通过SSL PINNING。</p>
<p>如果能把android 系统中hosts在/system/etc/hosts 是只读文件系统，我remount以后修改这个文件系统就会崩溃，随意没有尝试在android手机上直接将域名定向到server ip地址。</p>
<p>如果上述两点能正确实现，那就可以在局域网下，完成一个正经的HTTPS双向认证了。</p>
</blockquote>
<h2 id="0x7-webview-忽略证书验证"><a class="markdownIt-Anchor" href="#0x7-webview-忽略证书验证"></a> 0x7 WebView 忽略证书验证</h2>
<p>WebView 正常应该做成一个跳转页的，但是我为了图省事，就做了个小框在最下面，只是为了看是否访问成功。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*
* https协议
* WebView 不进行证书校验
*/</span>
button_webview_ssl_without_ca<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">MyWebViewClient</span> mWebViewClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyWebViewClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWebViewClient<span class="token punctuation">.</span><span class="token function">setCheckflag</span><span class="token punctuation">(</span><span class="token string">"trustAllCerts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWebview<span class="token punctuation">.</span><span class="token function">setWebViewClient</span><span class="token punctuation">(</span>mWebViewClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWebview<span class="token punctuation">.</span><span class="token function">loadUrl</span><span class="token punctuation">(</span><span class="token string">"https://www.baidu.com/?q=WebView_without_CAcheck"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上述代码片段中MyWebViewClient的实现如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">MyWebViewClient</span> <span class="token keyword">extends</span> <span class="token class-name">WebViewClient</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> checkflag<span class="token operator">=</span><span class="token string">"checkCerts"</span><span class="token punctuation">;</span> <span class="token comment">// 是否忽略证书校验</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCheckflag</span><span class="token punctuation">(</span><span class="token class-name">String</span> checkflag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>checkflag <span class="token operator">=</span> checkflag<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReceivedSslError</span><span class="token punctuation">(</span><span class="token class-name">WebView</span> view<span class="token punctuation">,</span> <span class="token class-name">SslErrorHandler</span> handler<span class="token punctuation">,</span> <span class="token class-name">SslError</span> error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"trustAllCerts"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>checkflag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            handler<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            handler<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Toast</span><span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token class-name">MainActivity</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"证书异常，停止访问"</span><span class="token punctuation">,</span> <span class="token class-name">Toast</span><span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样就做到了在遇到SSL错误时继续访问而中断访问，也不发出任何提醒。这样只需要配置好代理，甚至不需要安装代理证书就可以抓包了。</p>
<h2 id="0x8-webview-系统证书验证"><a class="markdownIt-Anchor" href="#0x8-webview-系统证书验证"></a> 0x8 WebView 系统证书验证</h2>
<p>很遗憾，WebView没有自定义SSL PINNING的实现方法，只能通过network_security_config.xml配置证书绑定。但这确实是一个很好的现象，在我看来把安全相关的业务逻辑交给普通开发者简直就是白给，这么做反而是提升安全性的最佳实践。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*
 * https协议
 * WebView 使用系统证书校验
 */</span>
button_webview_ssl_with_system_ca<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">MyWebViewClient</span> mWebViewClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyWebViewClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWebViewClient<span class="token punctuation">.</span><span class="token function">setCheckflag</span><span class="token punctuation">(</span><span class="token string">"checkCerts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWebview<span class="token punctuation">.</span><span class="token function">setWebViewClient</span><span class="token punctuation">(</span>mWebViewClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWebview<span class="token punctuation">.</span><span class="token function">loadUrl</span><span class="token punctuation">(</span><span class="token string">"https://www.baidu.com/?q=WebView_with_SystemCAcheck"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>baidu.com未在network_security_config.xml中配置证书绑定，所以访问 <a target="_blank" rel="noopener" href="https://www.baidu.com/">https://www.baidu.com/</a> 时只使用系统证书进行校验。</p>
<p>所以只需要将代理软件的证书加入系统证书列表就可以抓包解密明文了。</p>
<h2 id="0x9-webview-ssl-pinning"><a class="markdownIt-Anchor" href="#0x9-webview-ssl-pinning"></a> 0x9 WebView SSL PINNING</h2>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*
* https协议 SSL PINNING WebView
* 通过network_security_config.xml中定义的证书和密钥进行绑定
*/</span>
button_webview_ssl_pinning<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">MyWebViewClient</span> mWebViewClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyWebViewClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWebViewClient<span class="token punctuation">.</span><span class="token function">setCheckflag</span><span class="token punctuation">(</span><span class="token string">"checkCerts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWebview<span class="token punctuation">.</span><span class="token function">setWebViewClient</span><span class="token punctuation">(</span>mWebViewClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWebview<span class="token punctuation">.</span><span class="token function">loadUrl</span><span class="token punctuation">(</span><span class="token string">"https://www.sogou.com/web?query=WebView_SSLPinningXML"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 证书文件校验</span>
        <span class="token comment">// mWebview.loadUrl("https://www.zhihu.com/"); // 证书公钥校验</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>sogou.com和zhihu.com都通过network_security_config.xml做了证书绑定，所以直接访问的过程中就会触发SSL PINNING的验证。</p>
<p><strong>WebView SSL PINNING还不能通过0x-1附录的hook 代码unpinning</strong>，如果你有能unpinning的方法请务必告诉我。</p>
<h2 id="0x-1-附录"><a class="markdownIt-Anchor" href="#0x-1-附录"></a> 0x-1 附录</h2>
<p>Frida Hook Code:</p>
<p>usage: <code>frida -U -f com.example.httpstest -l ./frida_multiple_unpinning.js --no-pause</code></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/*  Android ssl certificate pinning bypass script for various methods
	by Maurizio Siddu modify by Ch3nYe

	Run with:
	frida -U -f [APP_ID] -l frida_multiple_unpinning.js --no-pause
*/</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'======'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[#] Android Bypass for various Certificate Pinning methods [#]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'======'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


		<span class="token keyword">var</span> X509TrustManager <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'javax.net.ssl.X509TrustManager'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">var</span> SSLContext <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'javax.net.ssl.SSLContext'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


		<span class="token comment">// TrustManager (Android &lt; 7) //</span>
		<span class="token comment">////////////////////////////////</span>
		<span class="token keyword">var</span> TrustManager <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">registerClass</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
			<span class="token comment">// Implement a custom TrustManager</span>
			name<span class="token operator">:</span> <span class="token string">'dev.asd.test.TrustManager'</span><span class="token punctuation">,</span>
			<span class="token keyword">implements</span><span class="token operator">:</span> <span class="token punctuation">[</span>X509TrustManager<span class="token punctuation">]</span><span class="token punctuation">,</span>
			methods<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
				<span class="token function-variable function">checkClientTrusted</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">chain<span class="token punctuation">,</span> authType</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
				<span class="token function-variable function">checkServerTrusted</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">chain<span class="token punctuation">,</span> authType</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
				<span class="token function-variable function">getAcceptedIssuers</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// Prepare the TrustManager array to pass to SSLContext.init()</span>
		<span class="token keyword">var</span> TrustManagers <span class="token operator">=</span> <span class="token punctuation">[</span>TrustManager<span class="token punctuation">.</span>$<span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token comment">// Get a handle on the init() on the SSLContext class</span>
		<span class="token keyword">var</span> SSLContext_init <span class="token operator">=</span> SSLContext<span class="token punctuation">.</span>init<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span>
			<span class="token string">'[Ljavax.net.ssl.KeyManager;'</span><span class="token punctuation">,</span> <span class="token string">'[Ljavax.net.ssl.TrustManager;'</span><span class="token punctuation">,</span> <span class="token string">'java.security.SecureRandom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Override the init method, specifying the custom TrustManager</span>
			SSLContext_init<span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">keyManager<span class="token punctuation">,</span> trustManager<span class="token punctuation">,</span> secureRandom</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing Trustmanager (Android &lt; 7) request'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">SSLContext_init</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> keyManager<span class="token punctuation">,</span> TrustManagers<span class="token punctuation">,</span> secureRandom<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] TrustManager (Android &lt; 7) pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>



		<span class="token comment">// OkHTTPv3 (quadruple bypass) //</span>
		<span class="token comment">/////////////////////////////////</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Bypass OkHTTPv3 &#123;1&#125;</span>
			<span class="token keyword">var</span> okhttp3_Activity_1 <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'okhttp3.CertificatePinner'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			okhttp3_Activity_1<span class="token punctuation">.</span>check<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'java.lang.String'</span><span class="token punctuation">,</span> <span class="token string">'java.util.List'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing OkHTTPv3 &#123;1&#125;: '</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] OkHTTPv3 &#123;1&#125; pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Bypass OkHTTPv3 &#123;2&#125;</span>
			<span class="token comment">// This method of CertificatePinner.check could be found in some old Android app</span>
			<span class="token keyword">var</span> okhttp3_Activity_2 <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'okhttp3.CertificatePinner'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			okhttp3_Activity_2<span class="token punctuation">.</span>check<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'java.lang.String'</span><span class="token punctuation">,</span> <span class="token string">'java.security.cert.Certificate'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing OkHTTPv3 &#123;2&#125;: '</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] OkHTTPv3 &#123;2&#125; pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Bypass OkHTTPv3 &#123;3&#125;</span>
			<span class="token keyword">var</span> okhttp3_Activity_3 <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'okhttp3.CertificatePinner'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			okhttp3_Activity_3<span class="token punctuation">.</span>check<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'java.lang.String'</span><span class="token punctuation">,</span> <span class="token string">'[Ljava.security.cert.Certificate;'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing OkHTTPv3 &#123;3&#125;: '</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] OkHTTPv3 &#123;3&#125; pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Bypass OkHTTPv3 &#123;4&#125;</span>
			<span class="token keyword">var</span> okhttp3_Activity_4 <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'okhttp3.CertificatePinner'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			okhttp3_Activity_4<span class="token punctuation">[</span><span class="token string">'check$okhttp'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing OkHTTPv3 &#123;4&#125;: '</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] OkHTTPv3 &#123;4&#125; pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>



		<span class="token comment">// Trustkit (triple bypass) //</span>
		<span class="token comment">//////////////////////////////</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Bypass Trustkit &#123;1&#125;</span>
			<span class="token keyword">var</span> trustkit_Activity_1 <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'com.datatheorem.android.trustkit.pinning.OkHostnameVerifier'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			trustkit_Activity_1<span class="token punctuation">.</span>verify<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'java.lang.String'</span><span class="token punctuation">,</span> <span class="token string">'javax.net.ssl.SSLSession'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing Trustkit &#123;1&#125;: '</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] Trustkit &#123;1&#125; pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Bypass Trustkit &#123;2&#125;</span>
			<span class="token keyword">var</span> trustkit_Activity_2 <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'com.datatheorem.android.trustkit.pinning.OkHostnameVerifier'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			trustkit_Activity_2<span class="token punctuation">.</span>verify<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'java.lang.String'</span><span class="token punctuation">,</span> <span class="token string">'java.security.cert.X509Certificate'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing Trustkit &#123;2&#125;: '</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] Trustkit &#123;2&#125; pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Bypass Trustkit &#123;3&#125;</span>
			<span class="token keyword">var</span> trustkit_PinningTrustManager <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'com.datatheorem.android.trustkit.pinning.PinningTrustManager'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			trustkit_PinningTrustManager<span class="token punctuation">.</span>checkServerTrusted<span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing Trustkit &#123;3&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] Trustkit &#123;3&#125; pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>




		<span class="token comment">// TrustManagerImpl (Android > 7) //</span>
		<span class="token comment">////////////////////////////////////</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">var</span> TrustManagerImpl <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'com.android.org.conscrypt.TrustManagerImpl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			TrustManagerImpl<span class="token punctuation">.</span>verifyChain<span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">untrustedChain<span class="token punctuation">,</span> trustAnchorChain<span class="token punctuation">,</span> host<span class="token punctuation">,</span> clientAuth<span class="token punctuation">,</span> ocspData<span class="token punctuation">,</span> tlsSctData</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing TrustManagerImpl (Android > 7): '</span> <span class="token operator">+</span> host<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> untrustedChain<span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] TrustManagerImpl (Android > 7) pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>



		<span class="token comment">// Appcelerator Titanium //</span>
		<span class="token comment">///////////////////////////</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">var</span> appcelerator_PinningTrustManager <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'appcelerator.https.PinningTrustManager'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			appcelerator_PinningTrustManager<span class="token punctuation">.</span>checkServerTrusted<span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing Appcelerator PinningTrustManager'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] Appcelerator PinningTrustManager pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>



		<span class="token comment">// OpenSSLSocketImpl Conscrypt //</span>
		<span class="token comment">/////////////////////////////////</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">var</span> OpenSSLSocketImpl <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'com.android.org.conscrypt.OpenSSLSocketImpl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			OpenSSLSocketImpl<span class="token punctuation">.</span>verifyCertificateChain<span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">certRefs<span class="token punctuation">,</span> JavaObject<span class="token punctuation">,</span> authMethod</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing OpenSSLSocketImpl Conscrypt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] OpenSSLSocketImpl Conscrypt pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>



		<span class="token comment">// OpenSSLEngineSocketImpl Conscrypt //</span>
		<span class="token comment">///////////////////////////////////////</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">var</span> OpenSSLEngineSocketImpl_Activity <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'com.android.org.conscrypt.OpenSSLEngineSocketImpl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			OpenSSLSocketImpl_Activity<span class="token punctuation">.</span>verifyCertificateChain<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'[Ljava.lang.Long;'</span><span class="token punctuation">,</span> <span class="token string">'java.lang.String'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing OpenSSLEngineSocketImpl Conscrypt: '</span> <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] OpenSSLEngineSocketImpl Conscrypt pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>



		<span class="token comment">// OpenSSLSocketImpl Apache Harmony //</span>
		<span class="token comment">//////////////////////////////////////</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">var</span> OpenSSLSocketImpl_Harmony <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'org.apache.harmony.xnet.provider.jsse.OpenSSLSocketImpl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			OpenSSLSocketImpl_Harmony<span class="token punctuation">.</span>verifyCertificateChain<span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">asn1DerEncodedCertificateChain<span class="token punctuation">,</span> authMethod</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing OpenSSLSocketImpl Apache Harmony'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] OpenSSLSocketImpl Apache Harmony pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>



		<span class="token comment">// PhoneGap sslCertificateChecker (https://github.com/EddyVerbruggen/SSLCertificateChecker-PhoneGap-Plugin) //</span>
		<span class="token comment">//////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">var</span> phonegap_Activity <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'nl.xservices.plugins.sslCertificateChecker'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			phonegap_Activity<span class="token punctuation">.</span>execute<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'java.lang.String'</span><span class="token punctuation">,</span> <span class="token string">'org.json.JSONArray'</span><span class="token punctuation">,</span> <span class="token string">'org.apache.cordova.CallbackContext'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing PhoneGap sslCertificateChecker: '</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] PhoneGap sslCertificateChecker pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>



		<span class="token comment">// IBM MobileFirst pinTrustedCertificatePublicKey (double bypass) //</span>
		<span class="token comment">////////////////////////////////////////////////////////////////////</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Bypass IBM MobileFirst &#123;1&#125;</span>
			<span class="token keyword">var</span> WLClient_Activity_1 <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'com.worklight.wlclient.api.WLClient'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			WLClient_Activity_1<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>pinTrustedCertificatePublicKey<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'java.lang.String'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">cert</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing IBM MobileFirst pinTrustedCertificatePublicKey &#123;1&#125;: '</span> <span class="token operator">+</span> cert<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] IBM MobileFirst pinTrustedCertificatePublicKey &#123;1&#125; pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Bypass IBM MobileFirst &#123;2&#125;</span>
			<span class="token keyword">var</span> WLClient_Activity_2 <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'com.worklight.wlclient.api.WLClient'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			WLClient_Activity_2<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>pinTrustedCertificatePublicKey<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'[Ljava.lang.String;'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">cert</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing IBM MobileFirst pinTrustedCertificatePublicKey &#123;2&#125;: '</span> <span class="token operator">+</span> cert<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] IBM MobileFirst pinTrustedCertificatePublicKey &#123;2&#125; pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>



		<span class="token comment">// IBM WorkLight (ancestor of MobileFirst) HostNameVerifierWithCertificatePinning (quadruple bypass) //</span>
		<span class="token comment">///////////////////////////////////////////////////////////////////////////////////////////////////////</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Bypass IBM WorkLight &#123;1&#125;</span>
			<span class="token keyword">var</span> worklight_Activity_1 <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'com.worklight.wlclient.certificatepinning.HostNameVerifierWithCertificatePinning'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			worklight_Activity_1<span class="token punctuation">.</span>verify<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'java.lang.String'</span><span class="token punctuation">,</span> <span class="token string">'javax.net.ssl.SSLSocket'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing IBM WorkLight HostNameVerifierWithCertificatePinning &#123;1&#125;: '</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] IBM WorkLight HostNameVerifierWithCertificatePinning &#123;1&#125; pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Bypass IBM WorkLight &#123;2&#125;</span>
			<span class="token keyword">var</span> worklight_Activity_2 <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'com.worklight.wlclient.certificatepinning.HostNameVerifierWithCertificatePinning'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			worklight_Activity_2<span class="token punctuation">.</span>verify<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'java.lang.String'</span><span class="token punctuation">,</span> <span class="token string">'java.security.cert.X509Certificate'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing IBM WorkLight HostNameVerifierWithCertificatePinning &#123;2&#125;: '</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] IBM WorkLight HostNameVerifierWithCertificatePinning &#123;2&#125; pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Bypass IBM WorkLight &#123;3&#125;</span>
			<span class="token keyword">var</span> worklight_Activity_3 <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'com.worklight.wlclient.certificatepinning.HostNameVerifierWithCertificatePinning'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			worklight_Activity_3<span class="token punctuation">.</span>verify<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'java.lang.String'</span><span class="token punctuation">,</span> <span class="token string">'[Ljava.lang.String;'</span><span class="token punctuation">,</span> <span class="token string">'[Ljava.lang.String;'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing IBM WorkLight HostNameVerifierWithCertificatePinning &#123;3&#125;: '</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] IBM WorkLight HostNameVerifierWithCertificatePinning &#123;3&#125; pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Bypass IBM WorkLight &#123;4&#125;</span>
			<span class="token keyword">var</span> worklight_Activity_4 <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'com.worklight.wlclient.certificatepinning.HostNameVerifierWithCertificatePinning'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			worklight_Activity_4<span class="token punctuation">.</span>verify<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'java.lang.String'</span><span class="token punctuation">,</span> <span class="token string">'javax.net.ssl.SSLSession'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing IBM WorkLight HostNameVerifierWithCertificatePinning &#123;4&#125;: '</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] IBM WorkLight HostNameVerifierWithCertificatePinning &#123;4&#125; pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>



		<span class="token comment">// Conscrypt CertPinManager //</span>
		<span class="token comment">//////////////////////////////</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">var</span> conscrypt_CertPinManager_Activity <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'com.android.org.conscrypt.CertPinManager'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			conscrypt_CertPinManager_Activity<span class="token punctuation">.</span>isChainValid<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'java.lang.String'</span><span class="token punctuation">,</span> <span class="token string">'java.util.List'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing Conscrypt CertPinManager: '</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] Conscrypt CertPinManager pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>



		<span class="token comment">// CWAC-Netsecurity (unofficial back-port pinner for Android&lt;4.2) CertPinManager //</span>
		<span class="token comment">///////////////////////////////////////////////////////////////////////////////////</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">var</span> cwac_CertPinManager_Activity <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'com.commonsware.cwac.netsecurity.conscrypt.CertPinManager'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			cwac_CertPinManager_Activity<span class="token punctuation">.</span>isChainValid<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'java.lang.String'</span><span class="token punctuation">,</span> <span class="token string">'java.util.List'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing CWAC-Netsecurity CertPinManager: '</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] CWAC-Netsecurity CertPinManager pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>



		<span class="token comment">// Worklight Androidgap WLCertificatePinningPlugin //</span>
		<span class="token comment">/////////////////////////////////////////////////////</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">var</span> androidgap_WLCertificatePinningPlugin_Activity <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'com.worklight.androidgap.plugin.WLCertificatePinningPlugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			androidgap_WLCertificatePinningPlugin_Activity<span class="token punctuation">.</span>execute<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'java.lang.String'</span><span class="token punctuation">,</span> <span class="token string">'org.json.JSONArray'</span><span class="token punctuation">,</span> <span class="token string">'org.apache.cordova.CallbackContext'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing Worklight Androidgap WLCertificatePinningPlugin: '</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] Worklight Androidgap WLCertificatePinningPlugin pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>



		<span class="token comment">// Netty FingerprintTrustManagerFactory //</span>
		<span class="token comment">//////////////////////////////////////////</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">var</span> netty_FingerprintTrustManagerFactory <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'io.netty.handler.ssl.util.FingerprintTrustManagerFactory'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//NOTE: sometimes this below implementation could be useful</span>
			<span class="token comment">//var netty_FingerprintTrustManagerFactory = Java.use('org.jboss.netty.handler.ssl.util.FingerprintTrustManagerFactory');</span>
			netty_FingerprintTrustManagerFactory<span class="token punctuation">.</span>checkTrusted<span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> chain</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing Netty FingerprintTrustManagerFactory'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] Netty FingerprintTrustManagerFactory pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>



		<span class="token comment">// Squareup CertificatePinner [OkHTTP&lt;v3] (double bypass) //</span>
		<span class="token comment">////////////////////////////////////////////////////////////</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Bypass Squareup CertificatePinner  &#123;1&#125;</span>
			<span class="token keyword">var</span> Squareup_CertificatePinner_Activity_1 <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'com.squareup.okhttp.CertificatePinner'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			Squareup_CertificatePinner_Activity_1<span class="token punctuation">.</span>check<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'java.lang.String'</span><span class="token punctuation">,</span> <span class="token string">'java.security.cert.Certificate'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing Squareup CertificatePinner &#123;1&#125;: '</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] Squareup CertificatePinner &#123;1&#125; pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Bypass Squareup CertificatePinner &#123;2&#125;</span>
			<span class="token keyword">var</span> Squareup_CertificatePinner_Activity_2 <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'com.squareup.okhttp.CertificatePinner'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			Squareup_CertificatePinner_Activity_2<span class="token punctuation">.</span>check<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'java.lang.String'</span><span class="token punctuation">,</span> <span class="token string">'java.util.List'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing Squareup CertificatePinner &#123;2&#125;: '</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] Squareup CertificatePinner &#123;2&#125; pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>



		<span class="token comment">// Squareup OkHostnameVerifier [OkHTTP v3] (double bypass) //</span>
		<span class="token comment">/////////////////////////////////////////////////////////////</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Bypass Squareup OkHostnameVerifier &#123;1&#125;</span>
			<span class="token keyword">var</span> Squareup_OkHostnameVerifier_Activity_1 <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'com.squareup.okhttp.internal.tls.OkHostnameVerifier'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			Squareup_OkHostnameVerifier_Activity_1<span class="token punctuation">.</span>verify<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'java.lang.String'</span><span class="token punctuation">,</span> <span class="token string">'java.security.cert.X509Certificate'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing Squareup OkHostnameVerifier &#123;1&#125;: '</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] Squareup OkHostnameVerifier pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Bypass Squareup OkHostnameVerifier &#123;2&#125;</span>
			<span class="token keyword">var</span> Squareup_OkHostnameVerifier_Activity_2 <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'com.squareup.okhttp.internal.tls.OkHostnameVerifier'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			Squareup_OkHostnameVerifier_Activity_2<span class="token punctuation">.</span>verify<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'java.lang.String'</span><span class="token punctuation">,</span> <span class="token string">'javax.net.ssl.SSLSession'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing Squareup OkHostnameVerifier &#123;2&#125;: '</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] Squareup OkHostnameVerifier pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>



		<span class="token comment">// Android WebViewClient (double bypass) //</span>
		<span class="token comment">///////////////////////////////////////////</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Bypass WebViewClient &#123;1&#125; (deprecated from Android 6)</span>
			<span class="token keyword">var</span> AndroidWebViewClient_Activity_1 <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'android.webkit.WebViewClient'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			AndroidWebViewClient_Activity_1<span class="token punctuation">.</span>onReceivedSslError<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'android.webkit.WebView'</span><span class="token punctuation">,</span> <span class="token string">'android.webkit.SslErrorHandler'</span><span class="token punctuation">,</span> <span class="token string">'android.net.http.SslError'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj1<span class="token punctuation">,</span> obj2<span class="token punctuation">,</span> obj3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing Android WebViewClient &#123;1&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] Android WebViewClient &#123;1&#125; pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Bypass WebViewClient &#123;2&#125;</span>
			<span class="token keyword">var</span> AndroidWebViewClient_Activity_2 <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'android.webkit.WebViewClient'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			AndroidWebViewClient_Activity_2<span class="token punctuation">.</span>onReceivedSslError<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'android.webkit.WebView'</span><span class="token punctuation">,</span> <span class="token string">'android.webkit.WebResourceRequest'</span><span class="token punctuation">,</span> <span class="token string">'android.webkit.WebResourceError'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj1<span class="token punctuation">,</span> obj2<span class="token punctuation">,</span> obj3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing Android WebViewClient &#123;2&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] Android WebViewClient &#123;2&#125; pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err)</span>
		<span class="token punctuation">&#125;</span>



		<span class="token comment">// Apache Cordova WebViewClient //</span>
		<span class="token comment">//////////////////////////////////</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">var</span> CordovaWebViewClient_Activity <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'org.apache.cordova.CordovaWebViewClient'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			CordovaWebViewClient_Activity<span class="token punctuation">.</span>onReceivedSslError<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'android.webkit.WebView'</span><span class="token punctuation">,</span> <span class="token string">'android.webkit.SslErrorHandler'</span><span class="token punctuation">,</span> <span class="token string">'android.net.http.SslError'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj1<span class="token punctuation">,</span> obj2<span class="token punctuation">,</span> obj3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing Apache Cordova WebViewClient'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				obj3<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] Apache Cordova WebViewClient pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>



		<span class="token comment">// Boye AbstractVerifier //</span>
		<span class="token comment">///////////////////////////</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">var</span> boye_AbstractVerifier <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'ch.boye.httpclientandroidlib.conn.ssl.AbstractVerifier'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			boye_AbstractVerifier<span class="token punctuation">.</span>verify<span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">host<span class="token punctuation">,</span> ssl</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bypassing Boye AbstractVerifier: '</span> <span class="token operator">+</span> host<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[-] Boye AbstractVerifier pinner not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//console.log(err);</span>
		<span class="token punctuation">&#125;</span>


	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>参考文章：</p>
<p><a target="_blank" rel="noopener" href="https://curz0n.github.io/2020/08/15/android-ssl-and-intercept/">Android HTTPS防抓包策略与对抗方法总结</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/blogs-of-lxl/p/10136582.html">Android : 关于HTTPS、TLS/SSL认证以及客户端证书导入方法 - sheldon_blogs - 博客园 (cnblogs.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/jjzhoujun2010/article/details/101442325">(19条消息) Android+Nginx一步步配置https单向/双向认证请求_Dream Fly的专栏-CSDN博客</a></p>

  </div>
  <div>
  
  <div class="post-note note-info copyright" style="margin-top: 42px">
    <p><span style="font-weight: bold;">作者：</span><a target="_blank" rel="nofollow noopener noreferrer" href="https://ch3nye.top/about">Ch3nYe</a></p>
    <p><span style="font-weight: bold;">文章链接：</span><a target="_blank" rel="nofollow noopener noreferrer" href="https://ch3nye.top/Android-HTTPS%E8%AE%A4%E8%AF%81%E7%9A%84N%E7%A7%8D%E6%96%B9%E5%BC%8F%E5%92%8C%E5%AF%B9%E6%8A%97%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/">https://ch3nye.top/Android-HTTPS%E8%AE%A4%E8%AF%81%E7%9A%84N%E7%A7%8D%E6%96%B9%E5%BC%8F%E5%92%8C%E5%AF%B9%E6%8A%97%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/</a></p>
    <p><span style="font-weight: bold;">版权声明：</span>本博客所有文章除特别声明外，均采用<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0 协议</a>。转载请注明出处！</p>
  </div>
  
  </div>
</article>
<div class="nav">
  
  <div class="nav-item-prev">
    <a href="/【实战】某交友app的双向认证crack/" class="nav-link">
      <i class="iconfont icon-left nav-prev-icon"></i>
      <div>
        <div class="nav-label">上一篇</div>
        
        <div class="nav-title">【实战】某交友app的双向认证crack </div>
        
      </div>
    </a>
  </div>
  
  
  <div class="nav-item-next">
    <a href="/Note-Deep-learning-for-cyber-security-intrusion-detection-Approaches-datasets-and-comparative-study/" class="nav-link">
      <div>
        <div class="nav-label">下一篇</div>
        
        <div class="nav-title">Note 《Deep learning for cyber security intrusion detection Approaches, datasets, and comparative study》 </div>
        
      </div>
      <i class="iconfont icon-right nav-next-icon"></i>
    </a>
  </div>
  
</div>

<div class="card card-content comment-card" style="margin-top: 16px;">
  <div class="comment-card-title">评论</div>
  
  <div id="gitalk-container"></div>
  
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

  
<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>

  <script>
    var gitalk = new Gitalk({
      clientID: '049b30eb10ea05082ef1',
      clientSecret: 'c33ad95041c69907b3136b895008320f000987db',
      repo: 'Ch3nYe.github.io',
      owner: 'Ch3nYe',
      admin: 'Ch3nYe',
      id: 'location.href',
      distractionFreeMode: 'false',
      language: 'navigator.language || navigator.userLanguage',
    })

    gitalk.render('gitalk-container')
  </script>

</div>

<div class="card card-content toc-card" id="mobiletoc">
  <div class="toc-header"><i class="iconfont icon-menu" style="padding-right: 2px;"></i>目录</div>
<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#android-https%E8%AE%A4%E8%AF%81%E7%9A%84n%E7%A7%8D%E6%96%B9%E5%BC%8F%E5%92%8C%E5%AF%B9%E6%8A%97%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93"><span class="toc-text"> Android HTTPS认证的N种方式和对抗方法总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x0-%E5%89%8D%E8%A8%80"><span class="toc-text"> 0x0 前言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#a-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-text"> a. 前置知识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#b-%E8%AE%BE%E5%A4%87%E7%8E%AF%E5%A2%83"><span class="toc-text"> b. 设备环境：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#c-%E7%AE%80%E5%8D%95%E9%85%8D%E7%BD%AE"><span class="toc-text"> c. 简单配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#d-demo-app"><span class="toc-text"> d. Demo APP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x1-http-%E7%9B%B4%E8%BF%9E"><span class="toc-text"> 0x1 HTTP 直连</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x2-https-%E5%BF%BD%E7%95%A5%E8%AF%81%E4%B9%A6%E9%AA%8C%E8%AF%81"><span class="toc-text"> 0x2 HTTPS 忽略证书验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x3-https-%E7%B3%BB%E7%BB%9F%E8%AF%81%E4%B9%A6%E6%A0%A1%E9%AA%8C"><span class="toc-text"> 0x3 HTTPS 系统证书校验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x4-ssl-pinning%E4%BB%A3%E7%A0%81%E6%A0%A1%E9%AA%8C"><span class="toc-text"> 0x4 SSL PINNING（代码校验）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x5-ssl-pinning%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text"> 0x5 SSL PINNING（配置文件）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x6-https-%E5%8F%8C%E5%90%91%E9%AA%8C%E8%AF%81"><span class="toc-text"> 0x6 HTTPS 双向验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x7-webview-%E5%BF%BD%E7%95%A5%E8%AF%81%E4%B9%A6%E9%AA%8C%E8%AF%81"><span class="toc-text"> 0x7 WebView 忽略证书验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x8-webview-%E7%B3%BB%E7%BB%9F%E8%AF%81%E4%B9%A6%E9%AA%8C%E8%AF%81"><span class="toc-text"> 0x8 WebView 系统证书验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x9-webview-ssl-pinning"><span class="toc-text"> 0x9 WebView SSL PINNING</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x-1-%E9%99%84%E5%BD%95"><span class="toc-text"> 0x-1 附录</span></a></li></ol></li></ol>
</div></main>
          <aside class="left-column">
            
            <div class="card card-author">
              
<img src="/images/logo.png" class="author-img">

<p class="author-name">Ch3nYe</p>
<p class="author-description">如果有文章有任何错误请留言，谢谢🙏</p>
<div class="author-message">
  <a class="author-posts-count" href="/archives">
    <span>31</span>
    <span>文章</span>
  </a>
  <a class="author-categories-count" href="/categories">
    <span>5</span>
    <span>分类</span>
  </a>
  <a class="author-tags-count" href="/tags">
    <span>41</span>
    <span>标签</span>
  </a>
</div>

<div class="author-card-society">
  
    <div class="author-card-society-icon">
      <a target="_blank" rel="noopener" href="https://github.com/ch3nye/">
        <i class="iconfont icon-github society-icon"></i>
      </a>
    </div>
  
    <div class="author-card-society-icon">
      <a href="mailto:sud0su@163.com">
        <i class="iconfont icon-mail society-icon"></i>
      </a>
    </div>
  
</div>

            </div>
            
            <div class="sticky-tablet">
  
  
  <article class="display-when-two-columns spacer">
    <div class="card card-content toc-card">
      <div class="toc-header"><i class="iconfont icon-menu" style="padding-right: 2px;"></i>目录</div>
<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#android-https%E8%AE%A4%E8%AF%81%E7%9A%84n%E7%A7%8D%E6%96%B9%E5%BC%8F%E5%92%8C%E5%AF%B9%E6%8A%97%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93"><span class="toc-text"> Android HTTPS认证的N种方式和对抗方法总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x0-%E5%89%8D%E8%A8%80"><span class="toc-text"> 0x0 前言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#a-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-text"> a. 前置知识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#b-%E8%AE%BE%E5%A4%87%E7%8E%AF%E5%A2%83"><span class="toc-text"> b. 设备环境：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#c-%E7%AE%80%E5%8D%95%E9%85%8D%E7%BD%AE"><span class="toc-text"> c. 简单配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#d-demo-app"><span class="toc-text"> d. Demo APP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x1-http-%E7%9B%B4%E8%BF%9E"><span class="toc-text"> 0x1 HTTP 直连</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x2-https-%E5%BF%BD%E7%95%A5%E8%AF%81%E4%B9%A6%E9%AA%8C%E8%AF%81"><span class="toc-text"> 0x2 HTTPS 忽略证书验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x3-https-%E7%B3%BB%E7%BB%9F%E8%AF%81%E4%B9%A6%E6%A0%A1%E9%AA%8C"><span class="toc-text"> 0x3 HTTPS 系统证书校验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x4-ssl-pinning%E4%BB%A3%E7%A0%81%E6%A0%A1%E9%AA%8C"><span class="toc-text"> 0x4 SSL PINNING（代码校验）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x5-ssl-pinning%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text"> 0x5 SSL PINNING（配置文件）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x6-https-%E5%8F%8C%E5%90%91%E9%AA%8C%E8%AF%81"><span class="toc-text"> 0x6 HTTPS 双向验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x7-webview-%E5%BF%BD%E7%95%A5%E8%AF%81%E4%B9%A6%E9%AA%8C%E8%AF%81"><span class="toc-text"> 0x7 WebView 忽略证书验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x8-webview-%E7%B3%BB%E7%BB%9F%E8%AF%81%E4%B9%A6%E9%AA%8C%E8%AF%81"><span class="toc-text"> 0x8 WebView 系统证书验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x9-webview-ssl-pinning"><span class="toc-text"> 0x9 WebView SSL PINNING</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x-1-%E9%99%84%E5%BD%95"><span class="toc-text"> 0x-1 附录</span></a></li></ol></li></ol>
    </div>
  </article>
  
  
  <article class="card card-content categories-widget">
    <div class="categories-card">
  <div class="categories-header"><i class="iconfont icon-fenlei" style="padding-right: 2px;"></i>分类</div>
  <div class="categories-list">
    
      <a href="/categories/备忘">
        <div class="categories-list-item">
          备忘
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/李宏毅机器学习笔记">
        <div class="categories-list-item">
          李宏毅机器学习笔记
          <span class="categories-list-item-badge">14</span>
        </div>
      </a>
    
      <a href="/categories/论文阅读">
        <div class="categories-list-item">
          论文阅读
          <span class="categories-list-item-badge">8</span>
        </div>
      </a>
    
      <a href="/categories/笔记">
        <div class="categories-list-item">
          笔记
          <span class="categories-list-item-badge">5</span>
        </div>
      </a>
    
      <a href="/categories/实战">
        <div class="categories-list-item">
          实战
          <span class="categories-list-item-badge">3</span>
        </div>
      </a>
    
  </div>
</div>
  </article>
  
  <article class="card card-content tags-widget">
    <div class="tags-card">
  <div class="tags-header"><i class="iconfont icon-biaoqian" style="padding-right: 2px;"></i>热门标签</div>
  <div class="tags-list">
    
    <a href="\tags\Next-Step-of-ML" title="Next-Step-of-ML"><div class="tags-list-item">Next-Step-of-ML</div></a>
    
    <a href="\tags\note" title="note"><div class="tags-list-item">note</div></a>
    
    <a href="\tags\ML" title="ML"><div class="tags-list-item">ML</div></a>
    
    <a href="\tags\笔记" title="笔记"><div class="tags-list-item">笔记</div></a>
    
    <a href="\tags\Android" title="Android"><div class="tags-list-item">Android</div></a>
    
    <a href="\tags\论文" title="论文"><div class="tags-list-item">论文</div></a>
    
    <a href="\tags\Deep-Learning" title="Deep-Learning"><div class="tags-list-item">Deep-Learning</div></a>
    
    <a href="\tags\实战" title="实战"><div class="tags-list-item">实战</div></a>
    
    <a href="\tags\crack" title="crack"><div class="tags-list-item">crack</div></a>
    
    <a href="\tags\二进制" title="二进制"><div class="tags-list-item">二进制</div></a>
    
    <a href="\tags\总结" title="总结"><div class="tags-list-item">总结</div></a>
    
    <a href="\tags\静态分析" title="静态分析"><div class="tags-list-item">静态分析</div></a>
    
    <a href="\tags\Reverse-Engineering" title="Reverse-Engineering"><div class="tags-list-item">Reverse-Engineering</div></a>
    
    <a href="\tags\Binary" title="Binary"><div class="tags-list-item">Binary</div></a>
    
    <a href="\tags\HTTPS" title="HTTPS"><div class="tags-list-item">HTTPS</div></a>
    
    <a href="\tags\学习" title="学习"><div class="tags-list-item">学习</div></a>
    
  </div>
</div>
  </article>
  
  
</div>
          </aside>
          <aside class="right-column">
            <div class="sticky-widescreen">
  
  
  <article class="card card-content toc-card">
    <div class="toc-header"><i class="iconfont icon-menu" style="padding-right: 2px;"></i>目录</div>
<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#android-https%E8%AE%A4%E8%AF%81%E7%9A%84n%E7%A7%8D%E6%96%B9%E5%BC%8F%E5%92%8C%E5%AF%B9%E6%8A%97%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93"><span class="toc-text"> Android HTTPS认证的N种方式和对抗方法总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x0-%E5%89%8D%E8%A8%80"><span class="toc-text"> 0x0 前言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#a-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-text"> a. 前置知识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#b-%E8%AE%BE%E5%A4%87%E7%8E%AF%E5%A2%83"><span class="toc-text"> b. 设备环境：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#c-%E7%AE%80%E5%8D%95%E9%85%8D%E7%BD%AE"><span class="toc-text"> c. 简单配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#d-demo-app"><span class="toc-text"> d. Demo APP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x1-http-%E7%9B%B4%E8%BF%9E"><span class="toc-text"> 0x1 HTTP 直连</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x2-https-%E5%BF%BD%E7%95%A5%E8%AF%81%E4%B9%A6%E9%AA%8C%E8%AF%81"><span class="toc-text"> 0x2 HTTPS 忽略证书验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x3-https-%E7%B3%BB%E7%BB%9F%E8%AF%81%E4%B9%A6%E6%A0%A1%E9%AA%8C"><span class="toc-text"> 0x3 HTTPS 系统证书校验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x4-ssl-pinning%E4%BB%A3%E7%A0%81%E6%A0%A1%E9%AA%8C"><span class="toc-text"> 0x4 SSL PINNING（代码校验）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x5-ssl-pinning%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text"> 0x5 SSL PINNING（配置文件）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x6-https-%E5%8F%8C%E5%90%91%E9%AA%8C%E8%AF%81"><span class="toc-text"> 0x6 HTTPS 双向验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x7-webview-%E5%BF%BD%E7%95%A5%E8%AF%81%E4%B9%A6%E9%AA%8C%E8%AF%81"><span class="toc-text"> 0x7 WebView 忽略证书验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x8-webview-%E7%B3%BB%E7%BB%9F%E8%AF%81%E4%B9%A6%E9%AA%8C%E8%AF%81"><span class="toc-text"> 0x8 WebView 系统证书验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x9-webview-ssl-pinning"><span class="toc-text"> 0x9 WebView SSL PINNING</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x-1-%E9%99%84%E5%BD%95"><span class="toc-text"> 0x-1 附录</span></a></li></ol></li></ol>
  </article>
  
  
  <article class="card card-content">
    <div class="recent-posts-card">
  <div class="recent-posts-header"><i class="iconfont icon-wenzhang_huaban" style="padding-right: 2px;"></i>最近文章</div>
  <div class="recent-posts-list">
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2021-08-21</div>
        <a href="/Note-PalmTree-CCS2021/"><div class="recent-posts-item-content">Note 《PalmTree Learning an Assembly Language Model for Instruction Embedding》</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2021-07-06</div>
        <a href="/Note-NFRE/"><div class="recent-posts-item-content">Note《A Lightweight Framework for Function Name Reassignment Based on Large-Scale Stripped Binaries》</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2021-05-29</div>
        <a href="/Note-DeepPayload-Black-box-Backdoor-Attack-on-Deep-Learning-Models-through-Neural-Payload-Injection/"><div class="recent-posts-item-content">Note《DeepPayload Black-box Backdoor Attack on Deep Learning Models through Neural Payload Injection》</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2021-05-06</div>
        <a href="/【实战】某交友app的双向认证crack/"><div class="recent-posts-item-content">【实战】某交友app的双向认证crack</div></a>
      </div>
    
  </div>
</div>
  </article>
  
  
</div>
          </aside>
        </div>
      </div>
    </div>
  </div>
  
  <footer class="footer">
  <div class="footer-container">
    <div>
      <div class="footer-dsc">
        <span>Copyright ©
          
          2020 -
          
          2021
        </span>
        &nbsp;
        <a href="/" class="footer-link">ch3nye's blog </a>
      </div>
    </div>

    
    <div class="footer-dsc">
      
      Powered by
      <a href="https://hexo.io/" class="footer-link" target="_blank" rel="nofollow noopener noreferrer">&nbsp;Hexo </a>
      
      
      <span>&nbsp;|&nbsp;</span>
      
      
      Theme -
      <a href="https://github.com/theme-kaze" class="footer-link" target="_blank"
        rel="nofollow noopener noreferrer">&nbsp;Kaze</a>
      
    </div>
    
    
    
    
      <div class="footer-dsc">
        
        本站总访问量<span id="busuanzi_value_site_pv"></span>次
        
        
        <span>&nbsp;|&nbsp;</span>
        
        
        本站总访客数<span id="busuanzi_value_site_uv"></span>次
        
      </div>
      
    
</footer>
  <a role="button" id="scrollbutton" class="basebutton"  aria-label="回到顶部">
  <i class="iconfont icon-arrowleft button-icon"></i>
</a>
<a role="button" id="menubutton" class="basebutton">
  <i class="iconfont icon-menu button-icon"></i>
</a>
<a role="button" id="popbutton" class="basebutton" aria-label="控制中心">
  <i class="iconfont icon-expand button-icon"></i>
</a>
<a role="button" id="darkbutton" class="basebutton darkwidget" aria-label="夜色模式">
  <i class="iconfont icon-weather button-icon"></i>
</a>
<a role="button" id="searchbutton" class="basebutton searchwidget" aria-label="搜索">
  <i class="iconfont icon-search button-icon"></i>
</a>

  
  
  

  
  
    
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css">

  

  
  
  <script>
  var addImgLayout = function () {
    var img = document.querySelectorAll('.post-content img');
    var i;
    for (i = 0; i < img.length; i++) {
      var wrapper = document.createElement('a');
      wrapper.setAttribute('data-fslightbox', 'gallery');
      wrapper.setAttribute('href', img[i].getAttribute('data-src'));
      wrapper.setAttribute('aria-label', 'illustration');
      wrapper.style.cssText = 'width: 100%; display: flex; justify-content: center;';
      img[i].before(wrapper);
      wrapper.append(img[i]);
    }
    refreshFsLightbox();
  }
</script>
<script>loadScript("//cdn.jsdelivr.net/npm/fslightbox@3.1.0/index.min.js", addImgLayout)</script>
  
  
  
<script src="/js/main.js"></script>

  
  <script>loadScript("/js/lib/busuanzi.min.js")</script>
  
  
  <script>
    var addLazyload = function () {
      var observer = lozad('.lozad', {
        load: function (el) {
          el.srcset = el.getAttribute('data-src');
        },
        loaded: function (el) {
          el.classList.add('loaded');
        }
      });
      observer.observe();
    }
  </script>
  <script>loadScript("/js/lib/lozad.min.js", addLazyload)</script>
  
  
  <script>
    var googleAnalytics = function() {
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-WHGL11014T');
    }
  </script>
  <script>loadScript("https://www.googletagmanager.com/gtag/js?id=" + "G-WHGL11014T", googleAnalytics)</script>
  
</body>

</html>